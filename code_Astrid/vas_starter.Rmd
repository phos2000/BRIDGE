---
title: "BRIDGE EQ5D VAS Clearance"
date: "`r Sys.Date()`"
author: "Astrid"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(knitr)
library(scales)
library(lubridate)
library(kableExtra)
library(stats)
```

# Preparation

## Source Data

Data in this version of output was pulled on 8/8/2022 using REDCapDB.Rmd and BRIDGE_DatIn_rename.R.

```{r data, echo=FALSE}
fu <- data.table::fread("../data/FollowDat.csv")
# bs <- data.table::fread("../data/FollowDat.csv")
```

## Check N

*We use study_arm & record_id to locate the number of unique participants.*

```{r check, message=FALSE, warning=FALSE}

#unique participants
tb1 <- fu %>% distinct(study_arm,record_id) %>% count(study_arm) 
tb1 %>% 
  kable(caption = "Number of unique participants in follow up dataset") %>% 
  kable_styling()

tb2 <- fu %>%
  filter(redcap_repeat_instrument=="follow_up_care_form") %>%
  distinct(study_arm,record_id) %>% count(study_arm) %>%
  left_join(tb1 %>% rename(tot=n)) %>% 
  mutate(pct=percent(n/tot)) 

tb2 %>% select(-tot) %>% 
  kable(caption = "Number of unique participants with any follow-up care form records") %>% 
  kable_styling()
```

## locate variables that suggest missed visit

1.  **follow_up_care_form_complete**: does no help much.
2.  **diagnosis_of_seizures_v2(**variable name: confirmseize)
3.  **weight_fu_v2**
4.  **confirm_seizure_class_v2**(variable name: seizeclass)

For **added_question_for_fup**(variable name: qolie): which is the VAS question, we will see the missing level later.

I adjusted the denominator to be just the number of follow up care forms(FCFs) -- as we focus on the incomplete cases for FCF, the missing rate seems more reasonable.

Basic demographic includes:

-   gender

-   agefu

-   grade

-   location

```{r miss, eval=TRUE, message=FALSE, warning=FALSE}

# build a new dataset tb3 only including the follow_up_care_form
# if follow-up-care form complete index != 2 or any one in the varl is NA
fcf <- fu  %>%
  filter(redcap_repeat_instrument=="follow_up_care_form") %>%
  select(record_id, redcap_repeat_instrument, redcap_repeat_instance, study_arm, latfu, lonfu,	datefu,	chwidfu,	name_chwfu,	agefu,	newmed,	weight_fu_v2,	height,	head_circum,	arm_circum,	temp_v2,	confirmseize,	seizeclass,	eyes_v2,	enmt_v2,	heart_v2,	resp_v2,	gi_v2,	musculoeskeletal_v2,	skin_v2,	neurological_v2,	psych_v2,	hormones_v2,	blood_v2,	skin_disorder_v2,	anemia,	sicklecell,	nhl,	leukemia,	hl,	multimyeloma,	working_memory_v2,	spontanoeous_speech_v2,	comprehemsion_v2,	naming_v2,	repetition_v2,	reading_optional_v2,	affect_v2,	right_arm_v2,	left_arm_v2,	right_leg_v2,	left_leg_v2,	right_arm2_v2,	left_arm2_v2,	right_leg2_v2,	left_leg2_v2,	right_arm3_v2,	left_arm3_v2,	right_leg3_v2,	left_leg3_v2,	weakness,	which_weak,	tremor_present_v2,	type_of_tremor_v2,	normal_walking_v2,	nodelays,	motor,	speech,	cognitive,	social,	other,	dev_regression_v2,	expseiz,	how_many_seiz_v2,	when_last_seizure_v2,	prolonged_seiz_v2,	how_many_prolonged_v2,	treatment,	aednumber,	aed,	freqseiz_carb,	side_effect_carb_v2,	mdcomm_carb,	physicians_rec_carb_v2,	dose_step_car,	step1carb,	step2carb,	step3carb,	freqseiz_valp,	side_effect_valp_v2,	mdcomm_valp,	physicians_rec_valp_v2,	dose_step_val,	step1valp,	step2valp,	step3valp,	freqseiz_phen,	side_effect_phen_v2,	mdcomm_phen,	physicians_rec_phen_v2,	dose_step_phe,	step1phen,	step2phen,	step3phen,	deltamed,	medchange,	seize_since_last_euc_v2,	number_seiz,	prolonged_euc_v2,	number_prolonged_euc_v2,	last_pseiz,	in_aed_euc_v2,	combinedaed,	anti_epileptic_drug_euc_v2,	doseam,	dosenoon,	dosepm,	aed2,	doseam2,	dosenoon2,	dosepm2,	aed3,	doseam3,	dosenoon3,	dosepm3,	side_effects_euc_v2,	whicheffect_1,	whicheffect_2,	whicheffect_3,	whicheffect_4,	whicheffect_5,	whicheffect_6,	whicheffect_7,	whicheffect_8,	whicheffect_9,	whicheffect_10,	whicheffect_11,	whicheffect_12,	whicheffect_13,	whicheffect_14,	whicheffect_15,	seizaftaed,	deltafreq,	newabs,	qolie,	missed_fu, follow_up_care_form_complete)

fcf1 = fcf %>%
  mutate(incomplete=
           ifelse(follow_up_care_form_complete<2 | is.na(confirmseize) | is.na(weight_fu_v2) | is.na(seizeclass),1,0))

# follow_up_care_form_complete,seizeclass makes less sense
# confirmseize, 2.23%, 2.05%
# confirmseize + weight_fu_v2, 2.56%, 2.11%
# only weight_fu_v2, 2.53%, 2.07%
# expsize/weight, 100%(wrong), 3%
# add temp_v2, 2.67%, 2.19%
# add dev_regression_v2, 2.76%, 2.22%
# add qolie, 2.95%, 2.50%
# still not sensitive enough
# seizures_after_aed_euc_v2 = "seizaftaed",frequency_change_euc_v2 = "deltafreq", only remove the NAs
# I need to find one necessary but not must provided value: so it is NA when missed. 

#participants do not have any follow up care form records
fcf1 %>%
  group_by(study_arm) %>% 
  summarise(n_record_fcf=n(),incomplete_fcf=sum(incomplete)) %>% ungroup() %>% 
  mutate(pct=percent(incomplete_fcf/n_record_fcf)) %>% 
  kable(caption = "Records of FU care form not completed or missing seizure diagnoisis or weights or seizure classes") %>% 
  kable_styling()

fcf1 %>%
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n_record=n(),incomplete=sum(incomplete)) %>% ungroup() %>% 
  mutate(pct=percent(incomplete/n_record)) %>% 
  kable(caption = "Divided by follow-up visit") %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")

# fcf1 %>% filter(redcap_repeat_instrument=="follow_up_care_form",
                # incomplete==1) %>% count(qolie) %>% 
  # kable(caption = "Majority of them has VAS score of 50, currently all non-missing scores are included") %>% 
  # kable_styling()
#1 with  qolie of 50? should ignore this record? currently included
#NAs are not counted anyway, the number of NAs are less than qolie or 50

# the pct of incomplete in all qolie of 50
fcf1 %>% filter(redcap_repeat_instrument=="follow_up_care_form", qolie == 50) %>%
  group_by(study_arm,redcap_repeat_instance) %>%
  summarise(n_qolie_50=n(),incomplete_num=sum(incomplete)) %>% ungroup() %>%
  mutate(pct = percent(incomplete_num / n_qolie_50)) %>%
  kable(caption = "is Qolie of 50 a meaningful index for missing data? Maybe not so good") %>%
  kable_styling() %>% 
  scroll_box(height = "400px")

```

## the most reliable index for missing data: missed_fu variable

```{r check2, eval=TRUE, message=FALSE, warning=FALSE}

#missed_fu var
fcf1 %>% 
  filter(follow_up_care_form_complete==2) %>%
  count(missed_fu, sort = TRUE) %>%
  transmute(missed_fu, freq = n, pct = percent(freq / sum(freq))) %>%
  kable(caption = "missed_fu for all fcf",
              format = "html") %>% kable_styling() %>% 
  scroll_box(height = "400px")

# there're still some missing cases using the weight and seizure(sensitivity is low lol). 
# sometimes visit done but they use this question as a remark. 
```

I found some responses meaning not missing, and I picked them out:

-   "No",
-   "No missed",
-   "None",
-   "N0",
-   "Not missed",
-   "NO",
-   "No miss",
-   "No messing",
-   "No missen",
-   "No missing",
-   "0",
-   "On time"

For the NA(blank answers) and "Visit Done", we have no reasons to set them all as missing(Impossible with such a big number) or not missing(if they're just incomplete?).\
I use the important indices below to distinguish whether they are actually missing or not.

```{r check3, eval=TRUE, message=FALSE, warning=FALSE}
# set a few answers as the complete cases
# actually for the missing cases told by the missed_fu, we can just use regularization. We're trying to find an index for missed_fu == NA -- you can say what kind of mixing is acceptable for you. 
# Another way is to Bayes. 

# only those missed_fu == NA and have the important values(weight, seizure_dx, seizure_class) are accepted as existing cases
# maybe still idealized, but we have no evidence to prove they are not. 
## visit done is not a enough answer and causes conflicts sometimes. Visit done may be made up later(delay), but this one is missed. 
# how many kids have several records for the same instance
fcf2 = fcf1 %>%
  mutate(missed = ifelse(missed_fu %in% c("No", "No missed", "None", "N0", "Not missed", "NO", "No miss", "No missing", "No messing", "No missen", "0", "On time") | ((str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done") | is.na(missed_fu)) & incomplete == 0), 0, 1))

fcf2 %>%
  group_by(study_arm) %>% 
  summarise(n_record_fcf=n(),missed_num_fcf=sum(missed)) %>% ungroup() %>% 
  mutate(pct=percent(missed_num_fcf/n_record_fcf)) %>% 
  kable(caption = "Missing Rate in 2 arms respectively") %>% 
  kable_styling()

fcf2 %>%
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n_record_fcf=n(),missed_num_fcf=sum(missed)) %>% ungroup() %>% 
  mutate(pct=percent(missed_num_fcf/n_record_fcf)) %>% 
  kable(caption = "Missing rate among all visits") %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

```{r complete_dataset, message=FALSE, warning=FALSE}
# create new dataset -- fcf_c
fcf_c = fcf2 %>%
  filter(missed == 0)

fcf_c %>%
  distinct(study_arm,record_id) %>% count(study_arm) %>%
  left_join(fcf2 %>% distinct(study_arm,record_id) %>% count(study_arm) %>% rename(tot=n)) %>% 
  mutate(pct=percent(n/tot)) %>% select(-tot) %>% 
  kable(caption = "Number of unique participants after deleting missing visits") %>% 
  kable_styling()

fcf_c %>% 
  count(missed_fu, sort = TRUE) %>%
  transmute(missed_fu, freq = n, pct = percent(freq / sum(freq))) %>%
  kable(caption = "missed_fu for completed fcf",
              format = "html") %>% kable_styling() %>% 
  scroll_box(height = "400px")
```

```{r visit_done, echo = FALSE}
## category 1: "Visit done" but incomplete == 1, need to explore the instances: whether repeat -- None

#tb2x %>%
  #filter((str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done")) & incomplete == 1) %>%
  #group_by(redcap_repeat_instance) %>%
  #kable(caption = "'Visit Done'but incomplete = Yes") %>%
  #kable_styling() %>% 
  #scroll_box(width = "90%",height = "400px")

## category 2: "Visit done" while incomplete == 0, need to check whether they make up in this time.
## I think they are indeed missing ... so visit done is still some dirty data. 
#fcf1 %>%
  #filter((str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done")) & incomplete == 0) %>%
  #group_by(chwidfu, redcap_repeat_instance) %>%
  #kable(caption = "'Visit Done'but incomplete = No, seems like they're finally finished") %>%
  #kable_styling() %>% 
  #scroll_box(height = "400px")
```

## will they fill all the optional questions?

Some questions are required by RedCap. Others are optional.   

```{r check-not-required, message = FALSE, warning=FALSE}
#count missing
fcf_fill1 <- fcf2 %>% filter(missed == 1) %>% rowwise() %>% 
  mutate(miss_item=sum(is.na(c_across(head_circum:blood_v2)))+sum(is.na(c_across(working_memory_v2:left_leg3_v2))))

ggplot(data=fcf_fill1) + 
  geom_histogram(aes(x=miss_item),binwidth = 1) +
  facet_grid(study_arm~.) +
  theme_minimal() +
  xlab("Number of missing item") + ylab("Freq") +
  ggtitle("Missing any of the optional matrix questions in QOLIE-31 for missed cases")

fcf_fill1 %>%
  filter(miss_item < 5) %>%
  count(missed_fu, sort = TRUE) %>%
  transmute(missed_fu, freq = n) %>%
  kable(caption = "'missed_fu reasons for those who still complete most of the questions") %>%
  kable_styling() %>% 
  scroll_box(height = "400px")

# count missing for none-missed cases
fcf_fill0 <- fcf2 %>% filter(missed == 0) %>% rowwise() %>% 
  mutate(miss_item=sum(is.na(c_across(head_circum:blood_v2)))+sum(is.na(c_across(working_memory_v2:left_leg3_v2))))

ggplot(data=fcf_fill0) + 
  geom_histogram(aes(x=miss_item),binwidth = 1) +
  facet_grid(study_arm~.) +
  theme_minimal() +
  xlab("Number of missing item") + ylab("Freq") +
  ggtitle("Missing any of the optional matrix questions in QOLIE-31 after deleting the missed cases")


```


## What will they do if missing a visit?

-   As the highest instance is 10, they can't make it 11th.
-   If they missed the 8th, will they have another 8th?

Answer is NO -- if missed once, that one will be missed!

```{r check-repeated, message=FALSE, warning=FALSE}
fcf2 %>%
  group_by(record_id, study_arm, redcap_repeat_instance, chwidfu) %>%
  summarize(n()) %>%
  kable() %>%
  kable_styling() %>% 
  scroll_box(height = "400px")
```

## Check number of visits

Participants contribute different number of follow-up visit records.

Note: Each digit means one instance for follow up care form. So "1111111111" means the participant contributes 10 visits (instance 1-10).

Now the majority is 1111111110 and 1111111111.

After we delete the missing cases, the plot became really complicated ...

Chisq test shows that there's no siginificant difference betw

```{r visit, echo=FALSE, message=FALSE,fig.width=12, warning=FALSE}

#check number of visits
fcf_c_visits <- fcf_c %>% 
  select(record_id, visit=redcap_repeat_instance, study_arm) %>% mutate(value=1) %>% 
  pivot_wider(names_from = visit, names_prefix = "v", values_from = value) %>% 
  replace_na(list(v1=0,v2=0,v3=0,v4=0,v5=0,v6=0,v7=0,v8=0,v9=0,v10=0)) %>% 
  unite("fu_pattern",v1:v10,sep = "",remove = F)

#unique missing pattern
fcf_c_v_plot <- fcf_c_visits %>% count(study_arm,fu_pattern) %>% 
  group_by(study_arm) %>% 
  mutate(tot=sum(n)) %>% 
  ungroup() %>% 
  mutate(pct=n/tot,
         lbl=paste0(n," (",percent(pct,accuracy = 0.1),")")) %>%
  group_by(study_arm) %>%
  arrange(desc(pct)) %>%
  top_n(25, pct)

ggplot(data=fcf_c_v_plot,aes(x=fu_pattern,y=n)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=lbl),nudge_y = 40) +
  ylim(c(0,max(fcf_c_v_plot$n)+55)) +
  ylab("Number of participants") +
  xlab("Follow-up visit pattern") + 
  coord_flip() +
  facet_wrap(~study_arm) +
  theme_minimal() +
  ggtitle("Follow-up visit records of unique participants pattern (excluding missing cases) Top 25")

# get a chi-sq test for the 2 arms
chisq.test(x = fcf_c_v_plot$study_arm, y = fcf_c_v_plot$fu_pattern)
# no specific differences

#investigate
#tc <- fuw %>% filter(v1==0)
#raw <- tc %>% left_join(fu) #%>% select(record_id,starts_with("red"),city,study_arm)
#raw %>% distinct(city,study_arm,record_id) %>% count(city,study_arm) %>% 
  #kable(caption="Missing follow-up visit 1") %>% 
  #kable_styling() #two sites

```

# VAS scores

## Calculating EQ5D VAS scores (including zero score)

```{r calc0, echo=FALSE, message=FALSE, warning=FALSE}
#divide
tsc <- fcf_c %>% 
  filter(study_arm=="TSC") %>% 
  mutate(q=as.integer(qolie),q2=ifelse(is.na(q),-9,q)) 

euc <- fcf_c %>% 
  filter(study_arm=="EUC") %>%  
  mutate(q=as.integer(qolie),q2=ifelse(is.na(q),-9,q)) 


# add plot distribution
# summary(tsc$q)
# summary(euc$q)

bind_rows(tsc,euc) %>%  
  ggplot(aes(x=q2)) + 
  geom_histogram(binwidth = 2) +
  facet_grid(study_arm~.) +
  theme_minimal() +
  xlab("VAS") + ylab("Freq") +
  ggtitle("Distribution of valid scores (below 0 indicating NA)")

```

Summary Tables

1.  **Average score per patient**

NA ignored, averaging all fu visits at patient level (including zero) Only count patients with at least one valid score.

```{r calc1, echo=FALSE, message=FALSE, warning=FALSE}

#### VAS full ####
full <- list()
full$tsc <- tsc %>%
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(q,na.rm = T)) %>% 
  ungroup() 
full$euc <- euc %>% 
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(q,na.rm = T)) %>% 
  ungroup() 
# map(full,~summary(.x$mean_quolie))
s1 <- map_dbl(full,~sum(.x$mean_quolie,na.rm = T))
s2 <- map_dbl(full,~(.x %>% filter(mean_quolie>=0) %>% distinct(record_id) %>% nrow()))

# t-test
t_res = t.test(
  qolie ~ factor(study_arm),
  data = fcf_c,
  var.equal = TRUE
)

o1 <- data.frame(item="Average score per patient",
                 TSC_total=s1["tsc"] %>% unname(),
                 TSC_N=s2["tsc"] %>% unname(),
                 EUC_total=s1["euc"] %>% unname(),
                 EUC_N=s2["euc"] %>% unname(),
                 stringsAsFactors = F) %>% 
  mutate(TSC_per_patient=TSC_total/TSC_N,
         EUC_per_patient=EUC_total/EUC_N,
         diff=TSC_per_patient-EUC_per_patient,
         pvalue = format(t_res$p.value, digits = 3)) %>% 
  relocate(item,starts_with("tsc"),starts_with("euc"))

o1 %>% kable(caption = "EQ5D VAS") %>% 
  kable_styling()

```

2.  **Split by follow-up visit**

One patient only has one record for each visit, so no scores are averaged.

```{r calc2, echo=FALSE, message=FALSE, warning=FALSE}
#### by visit ####t2 <- bm2 %>% 

bv <- list()
bv$tsc <- tsc %>% filter(q>=0) 
bv$euc <- euc %>% filter(q>=0)  
# map(bv,~summary(.x$q))
# map(bv,~summary(.x$q))
s1x <- map(bv,~(
  .x %>% group_by(redcap_repeat_instance) %>% summarise(tot=sum(q,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2x <- map(bv,~(.x %>% distinct(redcap_repeat_instance,record_id) %>% count(redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o2 <- full_join(s1x,s2x) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient)

o2 %>% kable(caption = "EQ5D VAS Split up follow-up") %>% 
  kable_styling()

summary(lm(qolie ~ factor(study_arm) + factor(redcap_repeat_instance), fcf_c))
```

3.  **By visit - gender**

There is one unspecified gender value in EUC, excluded for now.

```{r calc3, echo=FALSE, message=FALSE,warning=F}
#### by gender, visit ####

#fill gender for all records
# fu %>% count(study_arm,gender) 
#there is one unspecified gender (exclude?)

# gender needs to join
gd <- fu %>% filter(!is.na(gender)) %>% distinct(record_id,gender,study_arm) 
bg <- list()
bg$tsc <- tsc %>% filter(q>=0) %>% left_join(gd) 
bg$euc <- euc %>% filter(q>=0) %>% left_join(gd)
# map(bg,~summary(.x$q))
# map(bg,~summary(.x$gender))
s1y <- map(bg,~(
  .x %>% filter(gender==1 | gender==2) %>% 
    group_by(gender,redcap_repeat_instance) %>% summarise(tot=sum(q,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2y <- map(bg,~(.x %>% filter(gender==1 | gender==2) %>% 
                  distinct(gender, redcap_repeat_instance,record_id) %>% 
                  count(gender,redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o3 <- full_join(s1y,s2y) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(gender,visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient) %>% 
  arrange(desc(gender),visit) %>% 
  mutate(gender=factor(gender,levels=1:2,labels=c("Female","Male")))

o3 %>% kable(caption = "EQ5D VAS Split up follow-up and gender") %>% 
  kable_styling()
```

No significant difference between 2 genders.\
Significant differences between 3 cities.

```{r left-join}
fcf_c = fcf_c %>% left_join(gd)

location <- fu %>% filter(!is.na(city)) %>% distinct(record_id,city,study_arm) 
fcf_c = fcf_c %>% left_join(location)

summary(lm(qolie ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(gender), fcf_c))
summary(lm(qolie ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(city), fcf_c))
```

## Exploring intervals between follow-up visits

I learnt from Lizet that participants could "enroll" through either the screening or the follow up project. If ev0=1 (screening) then use date_consent_screen, if ev0=0 (follow-up) then dataconsentenroll.

I confirmed in data that only participants who enrolled via follow-up have a dateconsentenroll value (a handful of missing date). In most cases, the consent enroll date is about a week after consent screening date.

**Expected schedule of follow-up visits** Only the first follow-up needs to be +/- 3 days, all else allow +/- 14 days.\
*Schedule:*\
\* instance 1 - Week 1\
\* instance 2 - Month 1\
\* instance 3 - Month 2\
\* instance 4 - Month 4\
\* instance 5 - Month 6\
\* instance 6 - Month 9\
\* instance 7 - Month 12\
\* instance 8 - Month 15\
\* instance 9 - Month 18\
\* instance 10 - Month 24\
*Expected time interval:*\
\* v1: 7 +/- 3 from v0\
\* v2: 28 +/- 14 from v0\
\* v3: 28 +/- 14 from v2\
\* v4: 56 +/- 14 from v3\
\* v5: 56 +/- 14 from v4\
\* v6: 84 +/- 14 from v5\
\* v7: 84 +/- 14 from v6\
\* v8: 84 +/- 14 from v7\
\* v9: 84 +/- 14 from v8\
\* v10: 168 +/- 14 from v9?

```{r int, echo=FALSE, message=FALSE,warning=F}
#get baseline date and age
tt <- fu %>% filter(redcap_repeat_instrument=="diag_enroll") %>% 
  mutate(de_screen=as_date(date_of_consent_screen),
         de_fu=as_date(dateconsentenroll)) %>% 
  mutate(m1=as.integer(is.na(de_screen)),m2=as.integer(is.na(de_fu))) %>% 
  mutate(date_baseline=as_date(ifelse(ev0==1,de_screen,de_fu)),
         agefu=age)

# tt %>% select(starts_with("de_"),date_baseline) %>% summary()
# 
# tt %>% mutate(dd=de_fu-de_screen) %>% pull(dd) %>% as.numeric() %>% summary()

# fub <- fu %>% filter(redcap_repeat_instrument=="diag_enroll") %>% 
#   select(record_id,study_arm,starts_with("date")) %>% 
#   mutate_at(vars(starts_with("date")),as_date)
# # datefu
# # dateassentenroll, dataconsentenroll, which date used as baseline
# fub %>% select(starts_with("date")) %>% summary() 
# print("Not sure which date to use as baseline, missingness could be an issue")

#check date of fu
fud <- fcf_c %>% 
  select(record_id,visit=redcap_repeat_instance,study_arm,datefu,agefu) %>% 
  mutate(date=as_date(datefu)) %>% 
  bind_rows(tt %>% rename(date=date_baseline) %>% select(record_id,study_arm,date,agefu) %>% mutate(visit=0))
#fu record missing date
#fud %>% filter(is.na(date),visit>0) %>% count(study_arm,visit) %>% 
#  kable(caption="number of records missing follow-up date") %>% 
#  kable_styling()

fudw <- fud %>% select(-datefu) %>% rename(age=agefu) %>% 
  pivot_wider(names_from = visit,
              values_from = c(date,age)) %>% 
  mutate(d01=as.integer(date_1-date_0),
         d12=as.integer(date_2-date_1),
         d23=as.integer(date_3-date_2),
         d34=as.integer(date_4-date_3),
         d45=as.integer(date_5-date_4),
         d56=as.integer(date_6-date_5),
         d67=as.integer(date_7-date_6),
         d78=as.integer(date_8-date_7))

save(fudw,file="fcf_dates_wide.rda")

cat("In the following table, column d01 describes time interval between baseline and the first follow-up vist; d12 describes time interval between 1st and 2nd visit.\n")

fudw %>% filter(study_arm=="EUC") %>% 
  select(starts_with("d")) %>% 
  select(-starts_with("date")) %>% 
  summary() %>% kable(caption="Range of intervals between follow up visits, EUC")  %>%
  kable_styling()
fudw %>% filter(study_arm=="TSC") %>% 
  select(starts_with("d")) %>% 
  select(-starts_with("date")) %>% 
  summary() %>% kable(caption="Range of intervals between follow up visits, TSC")  %>%
  kable_styling()



```

Mostly conformed with scheduled time. However, there seem to be some extreme values. How do we define "extreme"? Are we going to exclude any records with problematic date?

```{r int2, echo=FALSE, message=FALSE,warning=F}
pf <- function(v,m,t) {
  vv <- enquo(v)
  m1 <- fudw %>% pull(!!vv) %>% min(na.rm = T)
  m2 <- fudw %>% pull(!!vv) %>% max(na.rm = T)
  
  p <- fudw %>% ggplot(aes(x=study_arm,y=!!vv)) +
    geom_boxplot() +
    scale_y_continuous(breaks = c(m1,-100,0,m,100,m2))  +
    coord_flip() + theme_minimal() +
    ggtitle(t)
  print(p)
}

pf(d01,7,"Baseline-FU1: expected 1 week")
pf(d12,21,"FU1-FU2: expected 3 weeks")
pf(d23,28,"FU2-FU3: expected 4 weeks")
pf(d34,56,"FU3-FU4: expected 8 weeks")
pf(d45,56,"FU4-FU5: expected 8 weeks")
pf(d56,84,"FU5-FU6: expected 12 weeks")
pf(d67,84,"FU6-FU7: expected 12 weeks")
pf(d78,84,"FU7-FU8: expected 12 weeks")
```

## Missing VAS score (Updated on Aug 8)

The table below describes missing (NA) EQ5D VAS scores in all follow-up care form records. Missing score affects less than 1% of the records(after clearance).

```{r int missing, echo=FALSE, message=FALSE,warning=F}
cm <- fcf_c %>% 
  mutate(q=as.integer(qolie),miss=ifelse(is.na(q),1,0)) 

t1 <- cm %>% group_by(study_arm) %>% 
  summarise(tot_record=n(),miss_record=sum(miss),
            tot_headcount=n_distinct(record_id)) 
t2 <- cm %>% filter(miss==1) %>% group_by(study_arm) %>% 
  summarise(anymiss_headcount=n_distinct(record_id))
mh <- cm %>% filter(miss==1) %>% pull(record_id) %>% unique()
t3 <- cm %>% filter(record_id %in% mh) %>% 
  group_by(study_arm,record_id) %>% summarise(nms=sum(!is.na(q))) %>% 
  filter(nms==0) %>% 
  group_by(study_arm) %>% 
  summarise(lost_headcount=n()) 

full_join(t1,t2) %>% full_join(t3) %>% replace_na(list(lost_headcount=0)) %>% 
  mutate(pct_miss_record=percent(miss_record/tot_record),
         pct_anymiss_headcount=percent(anymiss_headcount/tot_headcount)) %>% 
  select(study_arm,contains("record"),contains("headcount")) %>% 
  kable(caption = "Missing EQ5D VAS scores") %>% 
  kable_styling()


cm %>% group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(tot_record=n(),miss_record=sum(miss)) %>% 
  mutate(pct_miss_record=percent(miss_record/tot_record)) %>% 
  kable(caption = "Missing EQ5D VAS scores, by visit") %>% 
  kable_styling()


ck <- cm %>% filter(record_id %in% mh) %>% 
  group_by(study_arm,record_id) %>% summarise(nms=sum(!is.na(q))) %>% 
  filter(nms==0) %>% pull(record_id)
# cm %>% filter(record_id %in% ck) %>% View()

```
