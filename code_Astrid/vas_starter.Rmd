---
title: "BRIDGE EQ5D VAS Clearance"
date: "`r Sys.Date()`"
author: "Astrid"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(knitr)
library(scales)
library(lubridate)
library(kableExtra)
```

# Preparation

## Source Data

Data in this version of output was pulled on 8/8/2022 using REDCapDB.Rmd and BRIDGE_DatIn_rename.R.

```{r data, echo=FALSE}
fu <- data.table::fread("../data/FollowDat.csv")
# bs <- data.table::fread("../data/FollowDat.csv")
```

## Check N

*We use record_id to locate the number of responses.*\
As we focus on the follow-up care form, we also check that.

```{r check, message=FALSE, warning=FALSE}

#unique participants
tb1 <- fu %>% distinct(study_arm,record_id) %>% count(study_arm) 
tb1 %>% 
  kable(caption = "Number of unique participants in follow up dataset") %>% 
  kable_styling()

tb2 <- fu %>%
  distinct(study_arm,record_id) %>% count(study_arm) %>%
  left_join(tb1 %>% rename(tot=n)) %>% 
  mutate(pct=percent(n/tot)) 
tb2 %>% select(-tot) %>% 
  kable(caption = "Number of unique participants with any follow-up care form records") %>% 
  kable_styling()
```

## locate variables that suggest missed visit

1.  **follow_up_care_form_complete**: does no help much.
2.  **diagnosis_of_seizures_v2(**variable name: confirmseize)
3.  **weight_fu_v2**
4.  **confirm_seizure_class_v2**(variable name: seizeclass)
5.  **added_question_for_fup**(variable name: qolie): which is the VAS question
6.  **psych_v2**: can only be measured at the scene theoretically

```{r miss, eval=TRUE, message=FALSE, warning=FALSE}

varl <- c("weight_fu_v2",
          "confirmseize")

# "seizeclass","expseiz","treatment")

# build a new dataset tb2x
# if follow-up-care form complete index != 2 or any one in the varl is NA
tb2x <- fu  %>%
  mutate(incomplete=
           ifelse(follow_up_care_form_complete<2 | is.na(confirmseize) | is.na(weight_fu_v2) | is.na(seizeclass) | is.na(qolie) | is.na(psych_v2),1,0))

# follow_up_care_form_complete,seizeclass makes less sense
# confirmseize, 2.23%, 2.05%
# confirmseize + weight_fu_v2, 2.56%, 2.11%
# only weight_fu_v2, 2.53%, 2.07%
# expsize/weight, 100%(wrong), 3%
# add temp_v2, 2.67%, 2.19%
# add dev_regression_v2, 2.76%, 2.22%
# add qolie, 2.95%, 2.50%
# still not sensitive enough
# seizures_after_aed_euc_v2 = "seizaftaed",frequency_change_euc_v2 = "deltafreq", only remove the NAs
# I need to find one necessary but not must provided value: so it is NA when missed. 

#participants do not have any follow up care form records
tb2x %>%
  group_by(study_arm) %>% 
  summarise(n_record=n(),incomplete=sum(incomplete)) %>% ungroup() %>% 
  mutate(pct=percent(incomplete/n_record)) %>% 
  kable(caption = "Records with FU care form not complete or missing seizure diagnoisis or weights or seizure classes or VAS score or psych score") %>% 
  kable_styling()

tb2x %>%
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n_record=n(),incomplete=sum(incomplete)) %>% ungroup() %>% 
  mutate(pct=percent(incomplete/n_record)) %>% 
  kable(caption = "Divided by follow-up visit") %>% 
  kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

# tb2x %>% filter(redcap_repeat_instrument=="follow_up_care_form",
                # incomplete==1) %>% count(qolie) %>% 
  # kable(caption = "Majority of them has VAS score of 50, currently all non-missing scores are included") %>% 
  # kable_styling()
#1 with  qolie of 50? should ignore this record? currently included
#NAs are not counted anyway, the number of NAs are less than qolie or 50

# the pct of incomplete in all qolie of 50
tb2x %>% filter(redcap_repeat_instrument=="follow_up_care_form", qolie == 50) %>%
  group_by(study_arm,redcap_repeat_instance) %>%
  summarise(n_qolie_50=n(),incomplete_num=sum(incomplete)) %>% ungroup() %>%
  mutate(pct = percent(incomplete_num / n_qolie_50)) %>%
  kable(caption = "is Qolie of 50 a meaningful index for missing data? Maybe not so good") %>%
  kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

```

## the most reliable index for missing data: missed_fu variable

```{r check2, eval=TRUE, message=FALSE, warning=FALSE}

#missed_fu var
tb3 <- fu %>% 
  filter(redcap_repeat_instrument=="follow_up_care_form",
         follow_up_care_form_complete==2) %>% 
  group_by(missed_fu) %>% 
  summarise(mean_qolie=mean(as.integer(qolie),na.rm = T),freq=n()) %>% 
  arrange(desc(freq)) 

tb3 %>% kable(caption = "missed_fu should indicate if this follow-up was missed and why",
              format = "html") %>% kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

# fu %>% 
#   filter(redcap_repeat_instrument=="follow_up_care_form",
#          follow_up_care_form_complete==2) %>% nrow()
# 8304/9139 is NA

tb2x %>%
  filter(incomplete == 0) %>%
  group_by(missed_fu) %>%
  summarise(mean_qolie=mean(as.integer(qolie),na.rm = T),freq=n()) %>% 
  arrange(desc(freq)) %>%
  kable(caption = "incomplete index = No, still lots of missing data",
              format = "html") %>% 
  kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

tb2x %>%
  filter(incomplete == 1) %>%
  group_by(missed_fu) %>%
  summarise(mean_qolie=mean(as.integer(qolie),na.rm = T),freq=n()) %>% 
  arrange(desc(freq)) %>%
  kable(caption = "incomplete index = Yes, recheck incomplete reasons",
              format = "html") %>% 
  kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

# there're still some missing cases using the weight and seizure(sensitivity is low lol). 
# sometimes visit done but they use this question as a remark. 
```

I found some responses meaning not missing, and I picked them out:

-   "No",
-   "No missed",
-   "None",
-   "N0",
-   "Not missed",
-   "NO",
-   "No miss",
-   "No messing",
-   "No missen",
-   "0",
-   "On time"

For the NA(blank answers), we have no reasons to set them all as missing(Impossible with such a big number) or not missing(if they're just incomplete?).\
I use the important indices below to distinguish whether the NAs are missing or not.

```{r check3, eval=TRUE, message=FALSE, warning=FALSE}
# set a few answers as the complete cases
# missed = ifelse(missed_fu %in% c("No", "No missed", "None", "N0", "Not missed", "NO", "No miss", "No messing", "No missen", "0", "On time") | str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done") | (is.na(missed_fu) & incomplete == 0), 0, 1)

# actually for the missing cases told by the missed_fu, we can just use regularization. We're trying to find an index for missed_fu == NA -- you can say what kind of mixing is acceptable for you. 
# Another way is to Bayes. 

# if all missed_fu == NA (idealized)
# tb2x %>%
#  mutate(missed = ifelse(missed_fu %in% c("No", "No missed", "None", "N0", "Not missed", "NO", "No miss", "No messing", "No missen", "0", "On time") | str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done") | is.na(missed_fu), 0, 1)) %>%
#  group_by(study_arm) %>% 
#  summarise(n_record=n(),incomplete_num=sum(missed)) %>% ungroup() %>% 
#  mutate(pct=percent(incomplete_num/n_record)) %>% 
#  kable(caption = "Missing Rate in 2 arms") %>% 
#  kable_styling()

#tb2x %>%
#  mutate(missed = ifelse(missed_fu %in% c("No", "No missed", "None", "N0", "Not missed", "NO", "No miss", "No messing", "No missen", "0", "On time") | str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done") | is.na(missed_fu), 0, 1)) %>%
#  group_by(study_arm,redcap_repeat_instance) %>% 
#  summarise(n_record=n(),incomplete_num=sum(missed)) %>% ungroup() %>% 
#  mutate(pct=percent(incomplete_num/n_record)) %>% 
#  kable(caption = "Missing rate among all") %>% 
#  kable_styling()


# only those missed_fu == NA and have the important values(qolie, weight, seizure_dx, seizure_class, psych) are accepted as existing cases
# maybe still idealized, but we have no evidence to prove they are not. 
## visit done is not a enough answer and causes conflicts sometimes. Visit done may be made up later(delay), but this one is missed. 
# how many kids have several records for the same instance
tb4 = tb2x %>%
  mutate(missed = ifelse(missed_fu %in% c("No", "No missed", "None", "N0", "Not missed", "NO", "No miss", "No messing", "No missen", "0", "On time") | (is.na(missed_fu) & incomplete == 0), 0, 1))

tb4 %>%
  group_by(study_arm) %>% 
  summarise(n_record=n(),incomplete_num=sum(missed)) %>% ungroup() %>% 
  mutate(pct=percent(incomplete_num/n_record)) %>% 
  kable(caption = "Missing Rate in 2 arms respectively") %>% 
  kable_styling()

tb4 %>%
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n_record=n(),incomplete_num=sum(missed)) %>% ungroup() %>% 
  mutate(pct=percent(incomplete_num/n_record)) %>% 
  kable(caption = "Missing rate among all visits") %>% 
  kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

# for instrument not fu, it will be NA.
fuc = tb4 %>%
  filter(missed == 0)

fuc_fu = fuc %>% filter(redcap_repeat_instrument=="follow_up_care_form")
```

## What it means by saying "visit done"?

Let's check some cases.

Althought they said "visit done", these responses were still full of blanks.

```{r visit_done}
## category 1: "Visit done" but incomplete == 1, need to explore the instances: whether repeat -- None

#tb2x %>%
  #filter((str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done")) & incomplete == 1) %>%
  #group_by(redcap_repeat_instance) %>%
  #kable(caption = "'Visit Done'but incomplete = Yes") %>%
  #kable_styling() %>% 
  #scroll_box(width = "90%",height = "400px")

## category 2: "Visit done" while incomplete == 0, need to check whether they make up in this time.
## I think they are indeed missing ... so visit done is still some dirty data. 
tb2x %>%
  filter((str_detect(missed_fu, "Visit done") | str_detect(missed_fu, "Visit Done")) & incomplete == 0) %>%
  group_by(chwidfu, redcap_repeat_instance) %>%
  kable(caption = "'Visit Done'but incomplete = No, seems like they're still not finished") %>%
  kable_styling() %>% 
  scroll_box(width = "90%",height = "400px")

```

## Check number of visits

Participants contribute different number of follow-up visit records.

Note: Each digit means one instance for follow up care form. So "1111111111" means the participant contributes 10 visits (instance 1-10).

Now the majority is 1111111110 and 1111111111.

After we delete the missing cases, the plot became really complicated ...

```{r visit, echo=FALSE, message=FALSE,fig.width=12, warning=FALSE}
#check number of visits
fuw <- fuc  %>% filter(redcap_repeat_instrument=="follow_up_care_form") %>% 
  select(record_id,visit=redcap_repeat_instance,study_arm) %>% mutate(value=1) %>% 
  pivot_wider(names_from = visit, names_prefix = "v", values_from = value) %>% 
  replace_na(list(v1=0,v2=0,v3=0,v4=0,v5=0,v6=0,v7=0,v8=0,v9=0,v10=0)) %>% 
  unite("fu_pattern",v1:v10,sep = "",remove = F)

#unique missing pattern
fuwp <- fuw %>% count(study_arm,fu_pattern) %>% 
  group_by(study_arm) %>% 
  mutate(tot=sum(n)) %>% 
  ungroup() %>% 
  mutate(pct=n/tot,
         lbl=paste0(n," (",percent(pct,accuracy = 0.1),")")) %>%
  group_by(study_arm) %>%
  arrange(desc(pct)) %>%
  top_n(20, pct)

ggplot(data=fuwp,aes(x=fu_pattern,y=n)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=lbl),nudge_y = 40) +
  ylim(c(0,max(fuwp$n)+55)) +
  ylab("Number of participants") +
  xlab("Follow-up visit pattern") + 
  coord_flip() +
  facet_wrap(~study_arm) +
  theme_minimal() +
  ggtitle("Follow-up visit records pattern (excluding missing cases) Top 20")


#investigate
tc <- fuw %>% filter(v1==0)
raw <- tc %>% left_join(fu) #%>% select(record_id,starts_with("red"),city,study_arm)
raw %>% distinct(city,study_arm,record_id) %>% count(city,study_arm) %>% 
  kable(caption="Missing follow-up visit 1") %>% 
  kable_styling() #two sites

```

# VAS scores

## Calculating EQ5D VAS scores (including zero score)

Before we clean the data, the total numbers of tsc and euc were around 7600. Now around 7200.

Mostly missing cases didn't finish VAS question.

```{r calc0, echo=FALSE, message=FALSE, warning=FALSE}
#divide
tsc <- fuc %>% filter(redcap_repeat_instrument=="follow_up_care_form") %>% 
  filter(study_arm=="TSC") %>% 
  mutate(q=as.integer(qolie),q2=ifelse(is.na(q),-9,q)) 

euc <- fuc %>% filter(redcap_repeat_instrument=="follow_up_care_form") %>% 
  filter(study_arm=="EUC") %>%  
  mutate(q=as.integer(qolie),q2=ifelse(is.na(q),-9,q)) 


# add plot distribution
# summary(tsc$q)
# summary(euc$q)

bind_rows(tsc,euc) %>%  
  ggplot(aes(x=q2)) + 
  geom_histogram(binwidth = 2) +
  facet_grid(study_arm~.) +
  theme_minimal() +
  xlab("VAS") + ylab("Freq") +
  ggtitle("Distribution of valid scores (below 0 indicating NA)")

```

Summary Tables

1.  **Average score per patient**

NA ignored, averaging all fu visits at patient level (including zero) Only count patients with at least one valid score.

```{r calc1, echo=FALSE, message=FALSE, warning=FALSE}

#### VAS full ####
full <- list()
full$tsc <- tsc %>%
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(q,na.rm = T)) %>% 
  ungroup() 
full$euc <- euc %>% 
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(q,na.rm = T)) %>% 
  ungroup() 
# map(full,~summary(.x$mean_quolie))
s1 <- map_dbl(full,~sum(.x$mean_quolie,na.rm = T))
s2 <- map_dbl(full,~(.x %>% filter(mean_quolie>=0) %>% distinct(record_id) %>% nrow()))
o1 <- data.frame(item="Average score per patient",
                 TSC_total=s1["tsc"] %>% unname(),
                 TSC_N=s2["tsc"] %>% unname(),
                 EUC_total=s1["euc"] %>% unname(),
                 EUC_N=s2["euc"] %>% unname(),
                 stringsAsFactors = F) %>% 
  mutate(TSC_per_patient=TSC_total/TSC_N,
         EUC_per_patient=EUC_total/EUC_N,
         diff=TSC_per_patient-EUC_per_patient) %>% 
  relocate(item,starts_with("tsc"),starts_with("euc"))

o1 %>% kable(caption = "EQ5D VAS") %>% 
  kable_styling()

```

2.  **Split by follow-up visit**

One patient only has one record for each visit, so no scores are averaged.

```{r calc2, echo=FALSE, message=FALSE, warning=FALSE}
#### by visit ####t2 <- bm2 %>% 

bv <- list()
bv$tsc <- tsc %>% filter(q>=0) 
bv$euc <- euc %>% filter(q>=0)  
# map(bv,~summary(.x$q))
# map(bv,~summary(.x$q))
s1x <- map(bv,~(
  .x %>% group_by(redcap_repeat_instance) %>% summarise(tot=sum(q,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2x <- map(bv,~(.x %>% distinct(redcap_repeat_instance,record_id) %>% count(redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o2 <- full_join(s1x,s2x) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient)



o2 %>% kable(caption = "EQ5D VAS Split up follow-up") %>% 
  kable_styling()
```

3.  **By visit - gender**

There is one unspecified gender value in EUC, excluded for now.

```{r calc3, echo=FALSE, message=FALSE,warning=F}
#### by gender, visit ####

#fill gender for all records
# fu %>% count(study_arm,gender) 
#there is one unspecified gender (exclude?)
ex1 <- fu %>% filter(!is.na(gender),gender>2) 
gd <- fu %>% filter(!is.na(gender)) %>% distinct(record_id,gender,study_arm) 
bg <- list()
bg$tsc <- tsc %>% filter(q>=0) %>% select(-gender) %>% left_join(gd) 
bg$euc <- euc %>% filter(q>=0) %>% select(-gender) %>% left_join(gd)
# map(bg,~summary(.x$q))
# map(bg,~summary(.x$gender))
s1y <- map(bg,~(
  .x %>% filter(gender==1 | gender==2) %>% 
    group_by(gender,redcap_repeat_instance) %>% summarise(tot=sum(q,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2y <- map(bg,~(.x %>% filter(gender==1 | gender==2) %>% 
                  distinct(gender, redcap_repeat_instance,record_id) %>% 
                  count(gender,redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o3 <- full_join(s1y,s2y) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(gender,visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient) %>% 
  arrange(desc(gender),visit) %>% 
  mutate(gender=factor(gender,levels=1:2,labels=c("Female","Male")))

o3 %>% kable(caption = "EQ5D VAS Split up follow-up and gender") %>% 
  kable_styling()
```

## Missing VAS score (Updated on Aug 12)

The table below describes missing (NA) EQ5D VAS scores in all follow-up care form records. Missing score affects less than 1% of all records(also less than Zilu's calculation. EUC from 0.59% to 0.40%, TSC from 0.83% to 0.65%).

```{r int missing, echo=FALSE, message=FALSE,warning=F}
cm <- fu %>% filter(redcap_repeat_instrument=="follow_up_care_form") %>% 
  mutate(q=as.integer(qolie),miss=ifelse(is.na(q),1,0)) 

t1 <- cm %>% group_by(study_arm) %>% 
  summarise(tot_record=n(),miss_record=sum(miss),
            tot_headcount=n_distinct(record_id)) 
t2 <- cm %>% filter(miss==1) %>% group_by(study_arm) %>% 
  summarise(anymiss_headcount=n_distinct(record_id))
mh <- cm %>% filter(miss==1) %>% pull(record_id) %>% unique()
t3 <- cm %>% filter(record_id %in% mh) %>% 
  group_by(study_arm,record_id) %>% summarise(nms=sum(!is.na(q))) %>% 
  filter(nms==0) %>% 
  group_by(study_arm) %>% 
  summarise(lost_headcount=n()) 

full_join(t1,t2) %>% full_join(t3) %>% replace_na(list(lost_headcount=0)) %>% 
  mutate(pct_miss_record=percent(miss_record/tot_record),
         pct_anymiss_headcount=percent(anymiss_headcount/tot_headcount)) %>% 
  select(study_arm,contains("record"),contains("headcount")) %>% 
  kable(caption = "Missing EQ5D VAS scores") %>% 
  kable_styling()


cm %>% group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(tot_record=n(),miss_record=sum(miss)) %>% 
  mutate(pct_miss_record=percent(miss_record/tot_record)) %>% 
  kable(caption = "Missing EQ5D VAS scores, by visit") %>% 
  kable_styling()


ck <- cm %>% filter(record_id %in% mh) %>% 
  group_by(study_arm,record_id) %>% summarise(nms=sum(!is.na(q))) %>% 
  filter(nms==0) %>% pull(record_id)
# cm %>% filter(record_id %in% ck) %>% View()

```
