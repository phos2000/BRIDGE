---
title: "BRIDGE Cost"
author: "Astrid"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(kableExtra)
```

# Cost Collection

Source: Local collection
Currency: Originially Naira, Need to be converted into USD based on the 2023 exchange rate: 540.8564

https://www.exchangerates.org.uk/USD-NGN-spot-exchange-rates-history-2023.html

Because we're estimate the present-day policy, all the unit cost will be based on the 2023 version(which is the MAX in the excel sheet). 

```{r parameterization_unit_cost}
cVisit_CHW_2023 = 500
cVisit_Physician_Private_2023 = 5000
cVisit_Physician_Gov_2023 = 2000
cSupervision_CHW_2023 = 1000

cAdmission_Hosp_Private_2023 = 10000
cAdmission_Hosp_Gov_2023 = 3000
cMRI_scan_2023 = 70000
cEEG_2023 = 20
cCT_scan_2023 = 40000

cPhenobarbitone_2023 = 24
cCarbamazepine_2023 = 16
cValproate_2023 = 62
cPhenytoin_2023 = 68
cLevetracetam_2023 = 83
cGabapentin_2023 = 70
# cLamotrigine

cCatering_2023 = 3000
cTraining_Facilitator_2023 = 1000
cTraining_CHW_2023 = 500
cTraining_Admin_2023 = 1000
cTravel_Facilitator_2023 = 40
cTravel_CHW_2023 = 40

exchange_Naira_to_USD = 1/540.8564
```

It is hard to track any individual's changes, I feel the CEA per individual is hard to estimate.
I'm able to get the total DALY for all patients in this project(after 2 years, they have an improvement -- maybe not exactly 2 year but we can calculate from the beginning to the end), and I'm able to get all consumed units in this project. 

There maybe some dropout in the research, it is like the waste and will be kept in the cost calculation. 

```{r treatment length}
#fudw
```

```{r unit_count}
# Year 1: between 7/1/2020 - 6/30/2021
# Year 2: between 7/1/2021 - 6/30/2022
# Year 3: between 7/1/2022 - 6/30/2023

## TSC ##

nVisit_CHW_TSC = 4505 + 2948 + 688
nVisit_Physician_Private_TSC = 5 + 2 + 2
nVisit_Physician_Gov_TSC = 493 + 428 + 246
nSupervision_CHW_TSC = 2.5

nAdmission_Hosp_Private_TSC = 3
nAdmission_Hosp_Gov_TSC = 3 + 19 + 1
nMRI_scan_TSC = 6
nEEG_TSC = 7
nCT_scan_TSC = 6

nPhenobarbitone_TSC = 2753 + 1800 + 379
nCarbamazepine_TSC = 1393 + 1064 + 264
nValproate_TSC = 324 + 196 + 49
nPhenytoin_TSC = 0
nLevetracetam_TSC = 4
nGabapentin_TSC = 1
nLamotrigine = 0

nCatering_TSC = 600 + 50
nTraining_Facilitator_TSC = 900 + 180
nTraining_CHW_TSC = 5400
nTraining_Admin_TSC = 0
nTravel_Facilitator_TSC = 0
nTravel_CHW_TSC = 484

## EUC ##

nVisit_CHW_EUC = 4660 + 2794 + 635
nVisit_Physician_Private_EUC = 21 + 14 + 8
nVisit_Physician_Gov_EUC = 991 + 833 + 485
nSupervision_CHW_EUC = 0

nAdmission_Hosp_Private_EUC = 1 + 2
nAdmission_Hosp_Gov_EUC = 4 + 13 + 3
nMRI_scan_EUC = 7
nEEG_EUC = 15 + 7 + 1
nCT_scan_EUC = 7

nPhenobarbitone_EUC = 468 + 355 + 99
nCarbamazepine_EUC = 2411 + 1828 + 432
nValproate_EUC = 206 + 139 + 47
nPhenytoin_EUC = 11 + 8 + 1
nLevetracetam_EUC = 67 + 55 + 23
nGabapentin_EUC = 54 + 52 + 20
nLamotrigine = 0

nCatering_EUC = 0
nTraining_Facilitator_EUC = 0
nTraining_CHW_EUC = 0
nTraining_Admin_EUC = 0
nTravel_Facilitator_EUC = 0
nTravel_CHW_EUC = 0

```

Use two arms' sum costs's difference to calculate!!

```{r cost_sum}
cTSC = cVisit_CHW_2023*exchange_Naira_to_USD*nVisit_CHW_TSC +
  cVisit_Physician_Private_2023 * exchange_Naira_to_USD * nVisit_Physician_Private_TSC + 
  cVisit_Physician_Gov_2023 * exchange_Naira_to_USD * nVisit_Physician_Gov_TSC +
  cSupervision_CHW_2023 * exchange_Naira_to_USD * nSupervision_CHW_TSC +
  cAdmission_Hosp_Private_2023 * exchange_Naira_to_USD * nAdmission_Hosp_Private_TSC + 
  cAdmission_Hosp_Gov_2023 * exchange_Naira_to_USD * nAdmission_Hosp_Gov_TSC +
  cMRI_scan_2023 * exchange_Naira_to_USD * nMRI_scan_TSC +
  cEEG_2023 * exchange_Naira_to_USD * nEEG_TSC +
  cCT_scan_2023 * exchange_Naira_to_USD * nCT_scan_TSC +
  cPhenobarbitone_2023 * exchange_Naira_to_USD * nPhenobarbitone_TSC +
  cCarbamazepine_2023 * exchange_Naira_to_USD * nCarbamazepine_TSC + 
  cValproate_2023 * exchange_Naira_to_USD * nValproate_TSC + 
  cPhenytoin_2023 * exchange_Naira_to_USD * nPhenobarbitone_TSC +
  cLevetracetam_2023 * exchange_Naira_to_USD * nLevetracetam_TSC +
  cGabapentin_2023 * exchange_Naira_to_USD * nGabapentin_TSC +
  cCatering_2023 * exchange_Naira_to_USD * nCatering_TSC + 
  cTraining_Facilitator_2023 * exchange_Naira_to_USD * nTraining_Facilitator_TSC +
  cTraining_CHW_2023 * exchange_Naira_to_USD * nTraining_Facilitator_TSC +
  cTraining_Admin_2023 * exchange_Naira_to_USD * nTraining_Admin_TSC + 
  cTravel_Facilitator_2023 * exchange_Naira_to_USD * nTravel_Facilitator_TSC +
  cTravel_CHW_2023 * exchange_Naira_to_USD * nTravel_CHW_TSC

cEUC = cVisit_CHW_2023*exchange_Naira_to_USD*nVisit_CHW_EUC +
  cVisit_Physician_Private_2023 * exchange_Naira_to_USD * nVisit_Physician_Private_EUC + 
  cVisit_Physician_Gov_2023 * exchange_Naira_to_USD * nVisit_Physician_Gov_EUC +
  cSupervision_CHW_2023 * exchange_Naira_to_USD * nSupervision_CHW_EUC +
  cAdmission_Hosp_Private_2023 * exchange_Naira_to_USD * nAdmission_Hosp_Private_EUC + 
  cAdmission_Hosp_Gov_2023 * exchange_Naira_to_USD * nAdmission_Hosp_Gov_EUC +
  cMRI_scan_2023 * exchange_Naira_to_USD * nMRI_scan_EUC +
  cEEG_2023 * exchange_Naira_to_USD * nEEG_EUC +
  cCT_scan_2023 * exchange_Naira_to_USD * nCT_scan_EUC +
  cPhenobarbitone_2023 * exchange_Naira_to_USD * nPhenobarbitone_EUC +
  cCarbamazepine_2023 * exchange_Naira_to_USD * nCarbamazepine_EUC + 
  cValproate_2023 * exchange_Naira_to_USD * nValproate_EUC + 
  cPhenytoin_2023 * exchange_Naira_to_USD * nPhenobarbitone_EUC +
  cLevetracetam_2023 * exchange_Naira_to_USD * nLevetracetam_EUC +
  cGabapentin_2023 * exchange_Naira_to_USD * nGabapentin_EUC +
  cCatering_2023 * exchange_Naira_to_USD * nCatering_EUC + 
  cTraining_Facilitator_2023 * exchange_Naira_to_USD * nTraining_Facilitator_EUC +
  cTraining_CHW_2023 * exchange_Naira_to_USD * nTraining_Facilitator_EUC +
  cTraining_Admin_2023 * exchange_Naira_to_USD * nTraining_Admin_EUC + 
  cTravel_Facilitator_2023 * exchange_Naira_to_USD * nTravel_Facilitator_EUC +
  cTravel_CHW_2023 * exchange_Naira_to_USD * nTravel_CHW_EUC

cTSC
cEUC
```

# Cost & DALY

Because EUC and TSC have different numbers of patients, we need to divide the summed number by the numbers of patients. 

As there're people dropout, finally people who didn't drop out making sense. So we need to have people at the final 10th visit's DALY and the cost for all people. 

## without drop-out people

```{r CEA_DALY}
load("CEA_Bridge.RData")

severity_DALY %>% count(study_arm)

incremental_cost_per = cTSC / nrow(severity_DALY[severity_DALY[["study_arm"]] == "TSC",]) - 
  cEUC / nrow(severity_DALY[severity_DALY[["study_arm"]] == "EUC",])

mean(severity_DALY[severity_DALY[["study_arm"]] == "TSC","DALY_2yr"])
mean(severity_DALY[severity_DALY[["study_arm"]] == "EUC","DALY_2yr"])

incremental_DALY_per = mean(severity_DALY[severity_DALY[["study_arm"]] == "TSC","DALY_2yr"]) - mean(severity_DALY[severity_DALY[["study_arm"]] == "EUC","DALY_2yr"])

incremental_cost_per / -incremental_DALY_per
```

## with drop-out people

After dropping out, we'll set their state to be just the same as previous.

```{r with-drop-out}
severity_wNA = seizure_times %>% select(record_id, visit, study_arm, seiz_freq) %>% spread(visit, seiz_freq, sep = "")
  
# severity_DALY %>% filter(is.na(visit1))

severity_censored = severity_wNA %>%
  filter(!(is.na(visit1) & is.na(visit2))) %>% 
  mutate(visit2 = ifelse(is.na(visit2), visit1, visit2),
         visit3 = ifelse(is.na(visit3), visit2, visit3),
         visit4 = ifelse(is.na(visit4), visit3, visit4),
         visit5 = ifelse(is.na(visit5), visit4, visit5),
         visit6 = ifelse(is.na(visit6), visit5, visit6),
         visit7 = ifelse(is.na(visit7), visit6, visit7),
         visit8 = ifelse(is.na(visit8), visit7, visit8),
         visit9 = ifelse(is.na(visit9), visit8, visit9),
         visit10 = ifelse(is.na(visit10), visit9, visit10))

severity_censored = severity_censored %>%
  mutate(
    zero_0_12 = ifelse(visit1 == 0 & visit2 == 0 & visit3 == 0 & visit4 == 0 & visit5 == 0 & visit6 == 0 & visit7 == 0, TRUE, FALSE),
    zero_3_15 = ifelse(visit3 == 0 & visit4 == 0 & visit5 == 0 & visit6 == 0 & visit7 == 0 & visit8 == 0, TRUE, FALSE),
    zero_6_18 = ifelse(visit5 == 0 & visit6 == 0 & visit7 == 0 & visit8 == 0 & visit9 == 0, TRUE, FALSE)) %>%
  mutate(across(starts_with("visit"), ~ ifelse(.x >= 1, "severe epilepsy", "less severe epilepsy"), .names = "severity_{.col}")) %>%
  mutate(severity_visit8 = ifelse(isTRUE(zero_0_12) & visit8 == 0, "seizure-free, treated", severity_visit8),
         severity_visit9 = ifelse(isTRUE(zero_3_15) & visit9 == 0, "seizure-free, treated", severity_visit9),
         severity_visit10 = ifelse(isTRUE(zero_6_18) & visit10 == 0, "seizure-free, treated", severity_visit9))

severity_DALY = severity_censored %>% 
  mutate(across(starts_with("severity_visit"), ~ ifelse(.x == "severe epilepsy", 0.552, ifelse(.x == "less severe epilepsy", 0.263, 0.049)), .names = "DALYw_{.col}")) %>% select(-DALYw_severity_visit1) %>%
  mutate(DALY_2yr = DALYw_severity_visit2 * 1/12 + DALYw_severity_visit3 * 1/12 + DALYw_severity_visit4 * 2/12 + DALYw_severity_visit5 * 2/12 + DALYw_severity_visit6 * 3/12 + DALYw_severity_visit7 * 3/12 + DALYw_severity_visit8 * 3/12 +  DALYw_severity_visit9 * 3/12 + DALYw_severity_visit10 * 6/12)

#severity_DALY %>% filter(is.na(DALY_2yr))

severity_DALY %>%
  group_by(study_arm) %>%
  summarize(mean(DALY_2yr) / 2)

severity_DALY %>% count(study_arm)

incremental_cost_per = cTSC / nrow(severity_DALY[severity_DALY[["study_arm"]] == "TSC",]) - 
  cEUC / nrow(severity_DALY[severity_DALY[["study_arm"]] == "EUC",])

mean(severity_DALY[severity_DALY[["study_arm"]] == "TSC","DALY_2yr"])
mean(severity_DALY[severity_DALY[["study_arm"]] == "EUC","DALY_2yr"])

incremental_DALY_per = mean(severity_DALY[severity_DALY[["study_arm"]] == "TSC","DALY_2yr"]) - mean(severity_DALY[severity_DALY[["study_arm"]] == "EUC","DALY_2yr"])

incremental_cost_per / -incremental_DALY_per

```

CEA threshold: 0.5 * GDPpc (2523 dollars in Nigeria (2023)) = 1261

https://tradingeconomics.com/nigeria/gdp-per-capita

0.5 from Ashley's slides

Next steps (Bridge, Astrid):  
1. Letâ€™s see how to include the benefits of those who drop out (but the cost has already delete drop-out)
2. ICER from VAS and QALYs â€” all the work you did before :)  
3. ICER, for major outcomes, re. Seizures (I.e., cost per seizures avoided or cost per seizure free)  

# QALY & CEA

```{r CEA_QALY}
qaly_vas = fcf_i %>% 
  group_by(study_arm, visit) %>%
  summarise(vas = mean(qolie)/100) %>% spread(visit, vas, sep = "") %>% 
  mutate(QALY_2yr = visit2 * 1/12 + visit3 * 1/12 + visit4 * 2/12 + visit5 * 2/12 + visit6 * 3/12 + visit7 * 3/12 + visit8 * 3/12 +  visit9 * 3/12 + visit10 * 6/12)

qaly_qolie = data_qolie %>% select(-qolie_sd) %>% spread(visit, qolie, sep = "") %>%
  mutate(QALY_2yr = (visit3 * 2/12 + visit10 * 22/12)/100)

qaly_vas %>%
  kable(caption = "QALY based on VAS") %>%
  kable_styling()

qaly_qolie %>%
  kable(caption = "QALY based on QOLIE") %>%
  kable_styling()

incremental_QALY_vas = qaly_vas[qaly_vas[["study_arm"]] == "TSC", "QALY_2yr"] - qaly_vas[qaly_vas[["study_arm"]] == "EUC", "QALY_2yr"]

incremental_cost_per / incremental_QALY_vas

incremental_QALY_qolie = qaly_qolie[qaly_qolie[["study_arm"]] == "TSC", "QALY_2yr"] - qaly_qolie[qaly_qolie[["study_arm"]] == "EUC", "QALY_2yr"]

incremental_cost_per / incremental_QALY_qolie
```

# Other outcomes

```{r outcome}
cost = data.frame("study_arm" = c("EUC", "TSC"), "cost" = c(cTSC / nrow(severity_DALY[severity_DALY[["study_arm"]] == "TSC",]), cEUC / nrow(severity_DALY[severity_DALY[["study_arm"]] == "EUC",])))

seizure_outcome = seizure_times %>% 
  group_by(study_arm, visit) %>%
  summarise(seiz_freq = mean(seiz_freq)) %>% spread(visit, seiz_freq, sep = "") %>%
  mutate(seizure_avoided = visit1 * 24 - (visit2 * 1/12 + visit3 * 1/12 + visit4 * 2/12 + visit5 * 2/12 + visit6 * 3/12 + visit7 * 3/12 + visit8 * 3/12 +  visit9 * 3/12 + visit10 * 6/12) * 12) %>%
  left_join(cost, by = "study_arm") %>%
  mutate(cost_per_seizure_avoided = cost / seizure_avoided)

seizure_outcome %>%
  kable(caption = "Outcome: seizure avoided") %>%
  kable_styling()

```