---
title: "QOLIE-31/QOLIE-AD-48 Timeline, Scores, and Hypothesis Tests"
date: "`r Sys.Date()`"
author: "Astrid"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(knitr)
library(scales)
library(lubridate)
library(kableExtra)
```

# Source Data

BRIDGE follow-up QOLIE 31 & 48 dataset for all sites. Data in this version was pulled on 8/8/2022.

```{r data, echo=FALSE}
fu <- data.table::fread("../data/FollowDat.csv")
load("original_qolie.rda")
```

Info used later:\
- age(dob), - gender, - sites.

```{r info}
gender <- fu %>% filter(!is.na(gender)) %>% distinct(record_id,gender,study_arm)
location <- fu %>% filter(!is.na(city)) %>% distinct(record_id,city,study_arm)
dob <- fu %>% mutate(bd=as_date(dob)) %>% filter(!is.na(bd)) %>% distinct(record_id,study_arm,bd)
# changes over time
# seizure <- fu %>% filter(!is.na(seizeclass)) %>% distinct(record_id,study_arm,seizeclass)
```

# QOLIE-31

Please refer to qolie31_survey.pdf and qolie31_scoring.pdf for original scale details.

```{r q31-score}
####score qolie 31####

score_q31 <- function(df) {
  d1 <- df %>% mutate(
    #seizure worry
    sw1=ifelse(q11==1,0,NA),
    sw1=ifelse(q11==2,20, sw1),
    sw1=ifelse(q11==3,40, sw1),
    sw1=ifelse(q11==4,60, sw1),
    sw1=ifelse(q11==5,80, sw1),
    sw1=ifelse(q11==6,100,sw1),
    
    sw2=ifelse(q21==1,0,NA),
    sw2=ifelse(q21==2,33.3,sw2),
    sw2=ifelse(q21==3,66.7,sw2),
    sw2=ifelse(q21==4,100, sw2),
    
    sw3=ifelse(q22==1,0,NA),
    sw3=ifelse(q22==2,50, sw3),
    sw3=ifelse(q22==3,100,sw3),
    
    sw4=ifelse(q23==1,0,NA),
    sw4=ifelse(q23==2,33.3,sw4),
    sw4=ifelse(q23==3,66.7,sw4),
    sw4=ifelse(q23==4,100, sw4),
    
    sw5=ifelse(q25==1,100,NA),
    sw5=ifelse(q25==2,75,sw5),
    sw5=ifelse(q25==3,50,sw5),
    sw5=ifelse(q25==4,25,sw5),
    sw5=ifelse(q25==5,0, sw5)
  ) %>% mutate(
    #overall quality of life
    ql1=q1*10,
    
    ql2=ifelse(q14==1,100,NA),
    ql2=ifelse(q14==2,75,ql2),
    ql2=ifelse(q14==3,50,ql2),
    ql2=ifelse(q14==4,25,ql2),
    ql2=ifelse(q14==5,0, ql2)
  ) %>% mutate(
    #emotional well-being
    ew1=ifelse(q3==1,0,NA),
    ew1=ifelse(q3==2,20, ew1),
    ew1=ifelse(q3==3,40, ew1),
    ew1=ifelse(q3==4,60, ew1),
    ew1=ifelse(q3==5,80, ew1),
    ew1=ifelse(q3==6,100,ew1),
    
    ew2=ifelse(q4==1,0,NA),
    ew2=ifelse(q4==2,20, ew2),
    ew2=ifelse(q4==3,40, ew2),
    ew2=ifelse(q4==4,60, ew2),
    ew2=ifelse(q4==5,80, ew2),
    ew2=ifelse(q4==6,100,ew2),
    
    ew3=ifelse(q5==1,100,NA),
    ew3=ifelse(q5==2,80,ew3),
    ew3=ifelse(q5==3,60,ew3),
    ew3=ifelse(q5==4,40,ew3),
    ew3=ifelse(q5==5,20,ew3),
    ew3=ifelse(q5==6,0, ew3),
    
    ew4=ifelse(q7==1,0,NA),
    ew4=ifelse(q7==2,20, ew4),
    ew4=ifelse(q7==3,40, ew4),
    ew4=ifelse(q7==4,60, ew4),
    ew4=ifelse(q7==5,80, ew4),
    ew4=ifelse(q7==6,100,ew4),
    
    ew5=ifelse(q9==1,100,NA),
    ew5=ifelse(q9==2,80,ew5),
    ew5=ifelse(q9==3,60,ew5),
    ew5=ifelse(q9==4,40,ew5),
    ew5=ifelse(q9==5,20,ew5),
    ew5=ifelse(q9==6,0, ew5),
  ) %>% mutate(
    #energy/fatigue
    ef1=ifelse(q2==1,100,NA),
    ef1=ifelse(q2==2,80,ef1),
    ef1=ifelse(q2==3,60,ef1),
    ef1=ifelse(q2==4,40,ef1),
    ef1=ifelse(q2==5,20,ef1),
    ef1=ifelse(q2==6,0, ef1),
    
    ef2=ifelse(q6==1,100,NA),
    ef2=ifelse(q6==2,80,ef2),
    ef2=ifelse(q6==3,60,ef2),
    ef2=ifelse(q6==4,40,ef2),
    ef2=ifelse(q6==5,20,ef2),
    ef2=ifelse(q6==6,0, ef2),
    
    ef3=ifelse(q8==1,0,NA),
    ef3=ifelse(q8==2,20, ef3),
    ef3=ifelse(q8==3,40, ef3),
    ef3=ifelse(q8==4,60, ef3),
    ef3=ifelse(q8==5,80, ef3),
    ef3=ifelse(q8==6,100,ef3),
    
    ef4=ifelse(q10==1,0,NA),
    ef4=ifelse(q10==2,20, ef4),
    ef4=ifelse(q10==3,40, ef4),
    ef4=ifelse(q10==4,60, ef4),
    ef4=ifelse(q10==5,80, ef4),
    ef4=ifelse(q10==6,100,ef4),
  ) %>% mutate(
    #cognitive
    cg1=ifelse(q12==1,0,NA),
    cg1=ifelse(q12==2,20, cg1),
    cg1=ifelse(q12==3,40, cg1),
    cg1=ifelse(q12==4,60, cg1),
    cg1=ifelse(q12==5,80, cg1),
    cg1=ifelse(q12==6,100,cg1),
    
    cg2=ifelse(q15==1,0,NA),
    cg2=ifelse(q15==2,33.3,cg2),
    cg2=ifelse(q15==3,66.7,cg2),
    cg2=ifelse(q15==4,100, cg2),
    
    cg3=ifelse(q16==1,0,NA),
    cg3=ifelse(q16==2,20, cg3),
    cg3=ifelse(q16==3,40, cg3),
    cg3=ifelse(q16==4,60, cg3),
    cg3=ifelse(q16==5,80, cg3),
    cg3=ifelse(q16==6,100,cg3),
    
    cg4=ifelse(q17==1,0,NA),
    cg4=ifelse(q17==2,20, cg4),
    cg4=ifelse(q17==3,40, cg4),
    cg4=ifelse(q17==4,60, cg4),
    cg4=ifelse(q17==5,80, cg4),
    cg4=ifelse(q17==6,100,cg4),
    
    cg5=ifelse(q18==1,0,NA),
    cg5=ifelse(q18==2,20, cg5),
    cg5=ifelse(q18==3,40, cg5),
    cg5=ifelse(q18==4,60, cg5),
    cg5=ifelse(q18==5,80, cg5),
    cg5=ifelse(q18==6,100,cg5),
    
    cg6=ifelse(q26==1,100,NA),
    cg6=ifelse(q26==2,75,cg6),
    cg6=ifelse(q26==3,50,cg6),
    cg6=ifelse(q26==4,25,cg6),
    cg6=ifelse(q26==5,0, cg6)
  ) %>% mutate(
    #medication effects
    me1=ifelse(q24==1,0,NA),
    me1=ifelse(q24==2,33.3,me1),
    me1=ifelse(q24==3,66.7,me1),
    me1=ifelse(q24==4,100, me1),
    
    me2=ifelse(q29==1,100,NA),
    me2=ifelse(q29==2,75,me2),
    me2=ifelse(q29==3,50,me2),
    me2=ifelse(q29==4,25,me2),
    me2=ifelse(q29==5,0, me2),
    
    me3=ifelse(q30==1,100,NA),
    me3=ifelse(q30==2,75,me3),
    me3=ifelse(q30==3,50,me3),
    me3=ifelse(q30==4,25,me3),
    me3=ifelse(q30==5,0, me3)
  ) %>% mutate(
    #social function
    sf1=ifelse(q13==1,0,NA),
    sf1=ifelse(q13==2,20, sf1),
    sf1=ifelse(q13==3,40, sf1),
    sf1=ifelse(q13==4,60, sf1),
    sf1=ifelse(q13==5,80, sf1),
    sf1=ifelse(q13==6,100,sf1),
    
    sf2=ifelse(q19==1,0,NA),
    sf2=ifelse(q19==2,25, sf2),
    sf2=ifelse(q19==3,50, sf2),
    sf2=ifelse(q19==4,75, sf2),
    sf2=ifelse(q19==5,100,sf2),
    
    sf3=ifelse(q20==1,0,NA),
    sf3=ifelse(q20==2,25, sf3),
    sf3=ifelse(q20==3,50, sf3),
    sf3=ifelse(q20==4,75, sf3),
    sf3=ifelse(q20==5,100,sf3),
    
    sf4=ifelse(q27==1,100,NA),
    sf4=ifelse(q27==2,75,sf4),
    sf4=ifelse(q27==3,50,sf4),
    sf4=ifelse(q27==4,25,sf4),
    sf4=ifelse(q27==5,0, sf4),
    
    sf5=ifelse(q28==1,100,NA),
    sf5=ifelse(q28==2,75,sf5),
    sf5=ifelse(q28==3,50,sf5),
    sf5=ifelse(q28==4,25,sf5),
    sf5=ifelse(q28==5,0, sf5)
  )
  
  #summarise: what to do with missing item? currently averaging by domain
  d1 %>% rowwise() %>% 
    mutate(sum_sw=mean(c(sw1,sw2,sw3,sw4,sw5),na.rm = T),
           sum_ql=mean(c(ql1,ql2),na.rm = T),
           sum_ew=mean(c(ew1,ew2,ew3,ew4,ew5),na.rm = T),
           sum_ef=mean(c(ef1,ef2,ef3,ef4),na.rm = T),
           sum_cg=mean(c(cg1,cg2,cg3,cg4,cg5,cg6),na.rm = T),
           sum_me=mean(c(me1,me2,me3),na.rm = T),
           sum_sf=mean(c(sf1,sf2,sf3,sf4,sf5),na.rm = T)
    ) %>% ungroup() %>% 
    mutate(overall=sum_sw*0.08+sum_ql*0.14+sum_ew*0.15+sum_ef*0.12+
             sum_cg*0.27+sum_me*0.03+sum_sf*0.21)
  #what if missing one domain?
  # return(d2)
}

```

## QOLIE-31 missing regions check

```{r r1}
r31 <-  score_q31(q31) 

#count missing
r31x <- r31 %>% rowwise() %>% 
  mutate(miss_item=sum(is.na(c_across(sw1:sf5))),
         miss_domain=sum(is.na(c_across(starts_with("sum")))))


ggplot(data=r31x) + 
  geom_histogram(aes(x=miss_item),binwidth = 1) +
  facet_grid(study_arm~.) +
  theme_minimal() +
  xlab("Number of missing item") + ylab("Freq") +
  ggtitle("Missing any of the 30 questions in QOLIE-31")

t31 <- r31x %>% mutate(miss_any_item=as.integer(miss_item>0),
                       miss_any_domain=as.integer(miss_domain>0),
                       miss_all=as.integer(miss_domain==7)) 

t31 %>% 
  group_by(study_arm) %>% 
  summarise(n=n(),
            miss_any_item=sum(miss_any_item),
            miss_any_domain=sum(miss_any_domain),
            miss_all=sum(miss_all)) %>% 
  kable(caption = "Missing any item or any domain (missing overall score?)") %>% 
  kable_styling()

t31 %>% 
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n=n(),
            miss_any_item=sum(miss_any_item),
            miss_any_domain=sum(miss_any_domain),
            miss_all=sum(miss_all)) %>% 
  kable(caption = "By visit") %>% 
  kable_styling()



ggplot(r31) + geom_boxplot(aes(x=study_arm,y=overall)) +
  coord_flip() + theme_minimal() + 
  ggtitle("Distribution of Qolie 31 Overall Score")

# r31 %>% filter(study_arm=="EUC") %>% 
#   select(starts_with("sum"),overall) %>% summary() %>% 
#   kable(caption = "QOLIE-31 - EUC") %>% 
#   kable_styling()
# r31 %>% filter(study_arm=="TSC") %>% 
#   select(starts_with("sum"),overall) %>% summary() %>% 
#   kable(caption = "QOLIE-31 - TSC") %>% 
#   kable_styling()


```

```{r r1x}
#### full
full <- list()
full$tsc <- r31x %>% filter(study_arm=="TSC") %>% 
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(overall,na.rm = T)) %>% 
  ungroup() 
full$euc <- r31x %>% filter(study_arm=="EUC") %>% 
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(overall,na.rm = T)) %>% 
  ungroup() 
# map(full,~summary(.x$mean_quolie))
s1 <- map_dbl(full,~sum(.x$mean_quolie,na.rm = T))
s2 <- map_dbl(full,~(.x %>% filter(mean_quolie>=0) %>% distinct(record_id) %>% nrow()))
o1 <- data.frame(item="Average score per patient",
                 TSC_total=s1["tsc"] %>% unname(),
                 TSC_N=s2["tsc"] %>% unname(),
                 EUC_total=s1["euc"] %>% unname(),
                 EUC_N=s2["euc"] %>% unname(),
                 stringsAsFactors = F) %>% 
  mutate(TSC_per_patient=TSC_total/TSC_N,
         EUC_per_patient=EUC_total/EUC_N,
         diff=TSC_per_patient-EUC_per_patient) %>% 
  relocate(item,starts_with("tsc"),starts_with("euc"))

o1 %>% kable(caption = "QOLIE-31") %>% 
  kable_styling()


#### by visit ####t2 <- bm2 %>% 

bv <- list()
bv$tsc <- r31x %>% filter(study_arm=="TSC") %>%  filter(overall>=0) 
bv$euc <- r31x %>% filter(study_arm=="EUC") %>%  filter(overall>=0)  
# map(bv,~summary(.x$q))
# map(bv,~summary(.x$q))
s1x <- map(bv,~(
  .x %>% group_by(redcap_repeat_instance) %>% summarise(tot=sum(overall,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2x <- map(bv,~(.x %>% distinct(redcap_repeat_instance,record_id) %>% count(redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o2 <- full_join(s1x,s2x) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient)



o2 %>% kable(caption = "QOLIE-31 Split up follow-up") %>% 
  kable_styling()


#### by gender, visit ####

#fill gender for all records
# fu %>% count(study_arm,gender) 
#there is one unspecified gender (exclude?)
ex1 <- fu %>% filter(!is.na(gender),gender>2) 
gd <- fu %>% filter(!is.na(gender)) %>% distinct(record_id,gender,study_arm) 
bg <- list()
bg$tsc <- r31x %>% filter(study_arm=="TSC") %>% filter(overall>=0) %>% left_join(gd) 
bg$euc <- r31x %>% filter(study_arm=="EUC") %>% filter(overall>=0)  %>% left_join(gd)
# map(bg,~summary(.x$q))
# map(bg,~summary(.x$gender))
s1y <- map(bg,~(
  .x %>% filter(gender==1 | gender==2) %>% 
    group_by(gender,redcap_repeat_instance) %>% summarise(tot=sum(overall,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2y <- map(bg,~(.x %>% filter(gender==1 | gender==2) %>% 
                  distinct(gender, redcap_repeat_instance,record_id) %>% 
                  count(gender,redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o3 <- full_join(s1y,s2y) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(gender,visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient) %>% 
  arrange(desc(gender),visit) %>% 
  mutate(gender=factor(gender,levels=1:2,labels=c("Female","Male")))

o3 %>% kable(caption = "QOLIE-48 Split up follow-up and gender") %>% 
  kable_styling()

```

## QOLIE 31 Hypothesis Testing

The records separately for every id are not enough.

```{r qolie31-hypothesis-testing}
q31info = r31 %>% left_join(gender) %>% left_join(dob) %>% left_join(location)

summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(study_arm):factor(redcap_repeat_instance), q31info))
summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(gender), q31info))
summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(city), q31info))
# summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(dob), q31info))
```

# QOLIE-AD-48

Please refer to Cramer 1999 QOLIE-AD-48.pdf for original scale details.

Question 16 and 18 are missing from the survey.

-   

    16. Had a problem with complicated projects that require organization or planning like computer games or difficult homework)?\

-   

    18. Had trouble finding the correct word?

Question 47 looks slightly different in order and preset (currently included in results):

-   Original instrumentL 47. Feel that your epilepsy kept you from doing things you like to do?\
    The following questions ask about your attitudes toward epilepsy. Circle one number for how often in the past 4 weeks you have had these attitudes. [Very (negative) = 1, A little (negative) = 2, Not sure = 3, A little (positive) = 4, Very (positive) = 51.

-   In our survey: The following questions are about your regular daily activities, such as chores at home, baby -sitting, going to school, gathering with friends and family, dong homework, or an extra activity after school. We want to know if you had an of the following difficulties with your regular activities as a result of any physical problems such as an illness or emotional problems, such as feeling sad or nervous.\
    In the past four weeks, how often have physical or emotional problems caused you to: Do fewer things than you would have liked to do? 1 Very often\
    2 Often\
    3 Sometimes\
    4 Not often\
    5 Never

**as ZZ, We decided to ignore the two missing questions and treat the slightly different question 47 same as the original one in scoring.**

One more question: there's two 27 in Cramer(1999), based on the context, which should be a typo.

```{r q48}
xwalk <- readxl::read_xlsx("../code_Astrid/qolie48_xwalk.xlsx")

vv = data.frame(vn_redcap=names(q48),x=1:length(names(q48)),stringsAsFactors = F) %>%
  left_join(xwalk, by = "vn_redcap") 
# there will be NA

#rename survey question to align with original questionnaire
for(i in 1:nrow(vv)) {
  if (is.na(vv$vn_Cramer[i])) {
    vv$vn_Cramer[i] = vv$vn_redcap[i]
  }
}

names(q48) = vv$vn_Cramer

# score for questions that have 5-point
sc5 <- function(dt,vf,vt) {
  v1 <- vf
  v1 <- ensym(v1)
  dd <- dt %>% select(!!v1) %>%
    mutate(v=ifelse(!!v1==1,0,NA),
           v=ifelse(!!v1==2,25, v),
           v=ifelse(!!v1==3,50, v),
           v=ifelse(!!v1==4,75, v),
           v=ifelse(!!v1==5,100,v)) %>% 
    select(-!!v1)
  names(dd) <- vt
  return(dd)
}


#score for questions that have 4-point
sc4 <- function(dt,vf,vt) {
  v1 <- vf
  v1 <- ensym(v1)
  dd <- dt %>% select(!!v1) %>%
    mutate(v=ifelse(!!v1==1,0,NA),
           v=ifelse(!!v1==2,33.3, v),
           v=ifelse(!!v1==3,66.7, v),
           v=ifelse(!!v1==4,100,  v)) %>% 
    select(-!!v1)
  names(dd) <- vt
  return(dd)
}

#missing 16,18 for now
score_q48 <- function(df) {
  #epilepsy impact
  ei <- list(
    lq = paste0("q",c(25,26,28:34,36,47,48)),
    lv = paste0("ei",1:12)
  )
  r_ei <- map2(ei$lq,ei$lv,~sc5(dt=df,vf=.x,vt=.y)) %>% bind_cols()
  
  #memory/concentration
  mc <- list(
    # lq = paste0("q",c(8,12:20)),
    lq = paste0("q",c(8,12:15,17,19,20)),
    # lv = paste0("mc",1:10)
    lv = paste0("mc",1:8)
  ) 
  r_mc <- map2(mc$lq,mc$lv,~sc5(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #attitudes toward epilepsy
  at <- list(
    lq = paste0("q",c(43:46)),
    lv = paste0("at",1:4)
  ) 
  r_at <- map2(at$lq,at$lv,~sc5(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #physical functioning
  pf <- list(
    lq = paste0("q",c(3:7)),
    lv = paste0("pf",1:5)
  ) 
  r_pf <- map2(pf$lq,pf$lv,~sc5(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #stigma (4 category)
  st <- list(
    lq = paste0("q",c(37:42)),
    lv = paste0("st",1:6)
  ) 
  r_st <- map2(st$lq,st$lv,~sc4(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #social support
  ss <- list(
    lq = paste0("q",c(21:24)),
    lv = paste0("ss",1:4)
  ) 
  r_ss <- map2(ss$lq,ss$lv,~sc5(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #school behavior
  sb <- list(
    lq = paste0("q",c(9:11,27)),
    lv = paste0("sb",1:4)
  ) 
  r_sb <- map2(sb$lq,sb$lv,~sc5(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #health perceptions
  hp <- list(
    lq = paste0("q",c(1,2,35)),
    lv = paste0("hp",1:3)
  ) 
  r_hp <- map2(hp$lq,hp$lv,~sc5(dt=df,vf=.x,vt=.y))  %>% bind_cols()
  
  #summarise: what to do with missing item? currently averaging by domain
  d1 <- bind_cols(r_ei,r_mc,r_at,r_pf,r_st,r_ss,r_sb,r_hp) %>% rowwise() %>% 
    mutate(sum_ei=mean(c_across(ei1:ei12),na.rm = T),
           # sum_mc=mean(c_across(mc1:mc10),na.rm = T),
           sum_mc=mean(c_across(mc1:mc8),na.rm = T),
           sum_at=mean(c_across(at1:at4),na.rm = T),
           sum_pf=mean(c_across(pf1:pf5),na.rm = T),
           sum_st=mean(c_across(st1:st6),na.rm = T),
           sum_ss=mean(c_across(ss1:ss4),na.rm = T),
           sum_sb=mean(c_across(sb1:sb4),na.rm = T),
           sum_hp=mean(c_across(hp1:hp3),na.rm = T)
    ) %>% ungroup() %>% 
    mutate(overall=sum_ei*0.31+
             sum_mc*0.17+
             sum_at*0.09+
             sum_pf*0.09+
             sum_st*0.13+
             sum_ss*0.02+
             sum_sb*0.06+
             sum_hp*0.12)
}

```

## QOLIE-48 missing regions check

```{r r2}

r48p <- score_q48(q48) 
r48 <- bind_cols(q48,r48p)

#count missing
r48x <- r48 %>% rowwise() %>% 
  mutate(miss_item=sum(is.na(c_across(ei1:hp3))),
         miss_domain=sum(is.na(c_across(starts_with("sum")))))


save(r48x,r31x,file="re_qolie.rda")

t48 <- r48x %>% mutate(miss_any_item=as.integer(miss_item>0),
                       miss_any_domain=as.integer(miss_domain>0),
                       miss_all=as.integer(miss_domain==8)) 

t48 %>% 
  group_by(study_arm) %>% 
  summarise(n=n(),
            miss_any_item=sum(miss_any_item),
            miss_any_domain=sum(miss_any_domain),
            miss_all=sum(miss_all)) %>% 
  kable(caption = "Missing any item or any domain (missing overall score?)") %>% 
  kable_styling()

t48 %>% 
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n=n(),
            miss_any_item=sum(miss_any_item),
            miss_any_domain=sum(miss_any_domain),
            miss_all=sum(miss_all)) %>% 
  kable(caption = "By visit") %>% 
  kable_styling()



r48x %>% mutate(miss_any=as.integer(miss_item>0)) %>% 
  count(study_arm,miss_any) %>% kable(caption="Missing any item") %>% 
  kable_styling()

r48x %>% mutate(domain=as.integer(miss_domain>0),
                all=as.integer(miss_domain==8)) %>% 
  group_by(study_arm) %>% 
  summarise(n=n(),miss_any_domain=sum(domain),miss_all=sum(all)) %>% 
  kable(caption = "Missing any domain (missing overall score?)") %>% 
  kable_styling()

r48x %>% mutate(domain=as.integer(miss_domain>0),
                all=as.integer(miss_domain==8)) %>% 
  group_by(study_arm,redcap_repeat_instance) %>% 
  summarise(n=n(),miss_any_domain=sum(domain),miss_all=sum(all)) %>% 
  kable(caption = "Missing any domain (missing overall score?)") %>% 
  kable_styling()


ggplot(r48) + geom_boxplot(aes(x=study_arm,y=overall)) +
  coord_flip() + theme_minimal() + 
  ggtitle("Distribution of Qolie 48 Overall Score")

# r31 %>% filter(study_arm=="EUC") %>% 
#   select(starts_with("sum"),overall) %>% summary() %>% 
#   kable(caption = "QOLIE-31 - EUC")
# r31 %>% filter(study_arm=="TSC") %>% 
#   select(starts_with("sum"),overall) %>% summary() %>% 
#   kable(caption = "QOLIE-31 - TSC")


```

```{r r2x}
#### full
full <- list()
full$tsc <- r48x %>% filter(study_arm=="TSC") %>% 
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(overall,na.rm = T)) %>% 
  ungroup() 
full$euc <- r48x %>% filter(study_arm=="EUC") %>% 
  group_by(record_id) %>% 
  summarise(mean_quolie=mean(overall,na.rm = T)) %>% 
  ungroup() 
# map(full,~summary(.x$mean_quolie))
s1 <- map_dbl(full,~sum(.x$mean_quolie,na.rm = T))
s2 <- map_dbl(full,~(.x %>% filter(mean_quolie>=0) %>% distinct(record_id) %>% nrow()))
o1 <- data.frame(item="Average score per patient",
                 TSC_total=s1["tsc"] %>% unname(),
                 TSC_N=s2["tsc"] %>% unname(),
                 EUC_total=s1["euc"] %>% unname(),
                 EUC_N=s2["euc"] %>% unname(),
                 stringsAsFactors = F) %>% 
  mutate(TSC_per_patient=TSC_total/TSC_N,
         EUC_per_patient=EUC_total/EUC_N,
         diff=TSC_per_patient-EUC_per_patient) %>% 
  relocate(item,starts_with("tsc"),starts_with("euc"))

o1 %>% kable(caption = "QOLIE-48") %>% 
  kable_styling()


#### by visit ####t2 <- bm2 %>% 

bv <- list()
bv$tsc <- r48x %>% filter(study_arm=="TSC") %>%  filter(overall>=0) 
bv$euc <- r48x %>% filter(study_arm=="EUC") %>%  filter(overall>=0)  
# map(bv,~summary(.x$q))
# map(bv,~summary(.x$q))
s1x <- map(bv,~(
  .x %>% group_by(redcap_repeat_instance) %>% summarise(tot=sum(overall,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2x <- map(bv,~(.x %>% distinct(redcap_repeat_instance,record_id) %>% count(redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o2 <- full_join(s1x,s2x) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient)



o2 %>% kable(caption = "QOLIE-48 Split up follow-up") %>% 
  kable_styling()


#### by gender, visit ####

#fill gender for all records
# fu %>% count(study_arm,gender) 
#there is one unspecified gender (exclude?)
ex1 <- fu %>% filter(!is.na(gender),gender>2) 
gd <- fu %>% filter(!is.na(gender)) %>% distinct(record_id,gender,study_arm) 
bg <- list()
bg$tsc <- r48x %>% filter(study_arm=="TSC") %>% filter(overall>=0) %>% left_join(gd) 
bg$euc <- r48x %>% filter(study_arm=="EUC") %>% filter(overall>=0)  %>% left_join(gd)
# map(bg,~summary(.x$q))
# map(bg,~summary(.x$gender))
s1y <- map(bg,~(
  .x %>% filter(gender==1 | gender==2) %>% 
    group_by(gender,redcap_repeat_instance) %>% summarise(tot=sum(overall,na.rm = T)) 
)) %>% bind_rows(.id="study_arm")
s2y <- map(bg,~(.x %>% filter(gender==1 | gender==2) %>% 
                  distinct(gender, redcap_repeat_instance,record_id) %>% 
                  count(gender,redcap_repeat_instance))) %>% bind_rows(.id="study_arm")

o3 <- full_join(s1y,s2y) %>% 
  mutate(per_patient=tot/n) %>% 
  pivot_wider(names_from = study_arm,values_from = tot:per_patient) %>% 
  select(gender,visit=redcap_repeat_instance,
         TSC_total=tot_tsc,
         TSC_N=n_tsc,
         TSC_per_patient=per_patient_tsc,
         EUC_total=tot_euc,
         EUC_N=n_euc,
         EUC_per_patient=per_patient_euc
  ) %>% 
  mutate(diff=TSC_per_patient-EUC_per_patient) %>% 
  arrange(desc(gender),visit) %>% 
  mutate(gender=factor(gender,levels=1:2,labels=c("Female","Male")))

o3 %>% kable(caption = "QOLIE-48 Split up follow-up and gender") %>% 
  kable_styling()

```

## QOLIE-AD-48 Hypothesis Testing

Focus on the interaction of study arm and instances.

```{r q48-hypothesis-testing}
q48info = r48 %>% left_join(gender) %>% left_join(dob) %>% left_join(location)

t_res = t.test(
  overall ~ factor(study_arm),
  data = q48info,
  var.equal = TRUE
)
# I'm thinking about diff-in-diff
summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(study_arm):factor(redcap_repeat_instance), q48info))
summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(gender), q48info))
summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(city), q48info))
# summary(lm(overall ~ factor(study_arm) + factor(redcap_repeat_instance) + factor(dob), q48info))

```

# Whole Timeline

for every record id, put all the records together

## Baseline date

Zilu learnt from Lizet that participants could "enroll" through either the screening or the follow up project. If ev0=1 (screening) then use date_consent_screen, if ev0=0 (follow-up) then dataconsentenroll.

Zilu confirmed in data that only participants who enrolled via follow-up have a dateconsentenroll value (a handful of missing date). In most cases, the consent enroll date is about a week after consent screening date.

A question need to solve later for time series analysis.

```{r baseline-date}
tt <- fu %>% filter(redcap_repeat_instrument=="diag_enroll") %>% 
  mutate(de_screen=as_date(date_of_consent_screen),
         de_fu=as_date(dateconsentenroll)) %>% 
  mutate(m1=as.integer(is.na(de_screen)),m2=as.integer(is.na(de_fu))) %>% 
  mutate(date_baseline=as_date(ifelse(ev0==1,de_screen,de_fu)),
         agefu=age)

tt %>% select(starts_with("de_"),date_baseline) %>% summary()
tt %>% mutate(dd=de_fu-de_screen) %>% pull(dd) %>% as.numeric() %>% summary()

fub <- fu %>% filter(redcap_repeat_instrument=="diag_enroll") %>%
  select(record_id,study_arm,ev0,starts_with("date")) %>%
  mutate_at(vars(starts_with("date")),as_date)
# datefu
# dateassentenroll, dataconsentenroll, which date used as baseline
fub %>% select(starts_with("date")) %>% summary()
cat("Not sure which date to use as baseline, missingness could be an issue")

basedate = fub %>% 
  mutate(datebaseline = as_date(ifelse(ev0 == 1, date_of_consent_screen, dateconsentenroll))) %>% 
  select(record_id, study_arm, ev0, datebaseline)
```

## Try to look into all the qolie times for every participant

```{r}
q48_scr %>% left_join(basedate) %>% mutate(datediff = difftime(dateqolie48, datebaseline, units= "days")) %>% count(ev0, datediff) %>% # mostly ev0 == 1(Screening), consistent with scr
  kable(caption = "difference between baseline date and Screening QOLIE-48 Date") %>%
  kable_styling() %>%
  scroll_box(height = "400px")
  
q48_fu %>% filter(redcap_repeat_instance == 1) %>% left_join(basedate) %>% mutate(datediff = difftime(dateqolie48, datebaseline, units= "days")) %>% count(ev0,datediff) %>% group_by(ev0) %>% mutate(n_sum = sum(n)) %>% 
  kable(caption = "difference between baseline date and Instance 1 QOLIE-48 Date") %>%
  kable_styling() %>%
  scroll_box(height = "400px")

# r31 %>% filter(redcap_repeat_instance == 1) %>% select(record_id, study_arm, dateqolie31, overall) %>%
#   inner_join(r48 %>% filter(redcap_repeat_instance == 1) %>% select(record_id, study_arm, dateqolie48, overall), by = c("record_id", "study_arm"), suffix = c("_31", "_48"))
# 
# r31 %>% filter(redcap_repeat_instance == 2) %>% select(record_id, study_arm, dateqolie31, overall) %>%
#   inner_join(r48 %>% filter(redcap_repeat_instance == 2) %>% select(record_id, study_arm, dateqolie48, overall), by = c("record_id", "study_arm"), suffix = c("_31", "_48"))
# 
# r31 %>% filter(redcap_repeat_instance == 3) %>% select(record_id, study_arm, dateqolie31, overall) %>%
#   inner_join(r48 %>% filter(redcap_repeat_instance == 3) %>% select(record_id, study_arm, dateqolie48, overall), by = c("record_id", "study_arm"), suffix = c("_31", "_48"))


#first try to get a melt
allqolie = r48x %>% 
              mutate(type = "QOLIE-AD-48", instance = redcap_repeat_instance) %>%
              select(record_id, study_arm, ev0, dateqolie48, overall, type, instance, miss_item, miss_domain) %>% 
              rename(dateqolie = dateqolie48, score = overall) %>%
  full_join(r31x %>% 
              mutate(type = "QOLIE-31", instance = redcap_repeat_instance) %>%
              select(record_id, study_arm, ev0, dateqolie31, overall, type, instance, miss_item, miss_domain) %>% 
              rename(dateqolie = dateqolie31, score = overall)) %>%
  left_join(basedate, by = c("record_id", "study_arm", "ev0"))

allqolie = allqolie %>% filter(!is.nan(score)) %>% count(record_id, sort = TRUE) %>% rename(qolietimes = n) %>% left_join(allqolie) %>% 
  select(record_id, study_arm, qolietimes, ev0, datebaseline, dateqolie, instance, type, score, miss_item, miss_domain) %>% left_join(dob) %>%
  mutate(age = as.numeric(dateqolie - bd)/365.25, eligibility = ifelse(age > 17, "QOLIE-31","QOLIE-AD-48")) %>% filter(!is.nan(score))

allqolie %>%
  arrange(desc(qolietimes), record_id, dateqolie, desc(miss_domain), desc(miss_item)) %>%
  kable(caption = "All qolie records with dates and scores") %>%
  kable_styling() %>%
  scroll_box(height = "400px")


# pivot table
# basedate %>% left_join(r48 %>% filter(redcap_repeat_instance == 0) %>% select(record_id, study_arm, ev0, dateqolie48, overall) %>% mutate(type_screen = "QOLIE-AD-48") %>% rename(dateqolie_screen = dateqolie48, score_screen = overall)) %>%
#   left_join(r48 %>% filter(redcap_repeat_instance == 1) %>% select(record_id, study_arm, ev0, dateqolie48, overall) %>% mutate(type_followup1 = "QOLIE-AD-48") %>% rename(dateqolie_followup1 = dateqolie48, score_followup1 = overall)) %>%
#   left_join(r48 %>% filter(redcap_repeat_instance == 2) %>% select(record_id, study_arm, ev0, dateqolie48, overall) %>% mutate(type_followup2 = "QOLIE-AD-48") %>% rename(dateqolie_followup2 = dateqolie48, score_followup2 = overall)) %>%
#   left_join(r31 %>% filter(redcap_repeat_instance == 1) %>% select(record_id, study_arm, ev0, dateqolie31, overall) %>% mutate(type_followup2 = "QOLIE-31") %>% rename(dateqolie_followup2 = dateqolie31, score_followup1 = overall))

```

Next Step:\

1.  for those with 2 times of QOLIE on the same date:

    if one is QOLIE-AD-48, the other is QOLIE-31, choose the one consistent with the age;

    if both are the same instruments, use the more completed one / the later one.

2.  for every record id, sort all the scores by time.

3.  Check the time interval between 2 times of QOLIE.

```{r clean}
repeated = allqolie %>% group_by(record_id) %>% count(dateqolie) %>% filter(n > 1) %>% rename(repeattime = n)
# All of ns are 2. 

repeatqolie = allqolie %>% left_join(repeated) %>% filter(repeattime == 2) %>% mutate(remove = 0)

for (i in seq(1,nrow(repeatqolie),2)){
  if (repeatqolie[i,"type"] != repeatqolie[i+1,"type"]){
    if (repeatqolie[i,"type"] == repeatqolie[i, "eligibility"]){
      repeatqolie[i+1, "remove"] = 1
    } else {
      repeatqolie[i, "remove"] = 1
    }
  } else {
    if (repeatqolie[i,"miss_item"] != repeatqolie[i+1, "miss_item"]) {
      max_item = max(repeatqolie[i,"miss_item"], repeatqolie[i+1,"miss_item"])
      if (repeatqolie[i,"miss_item"] == max_item) {
        repeatqolie[i,"remove"] = 1
      } else {
        repeatqolie[i+1,"remove"] = 1
      }
    } else {
      repeatqolie[i,"remove"] = 1
    }
  }
}

allqolie_c = allqolie %>% left_join(repeatqolie) %>% filter(remove == 0 | is.na(remove)) %>% select(-repeattime, -remove, -qolietimes)
allqolie_c = allqolie_c %>% count(record_id, sort = TRUE) %>% rename(qolietimes = n) %>% left_join(allqolie_c)
allqolie_c = allqolie_c %>% mutate(eligibility = ifelse(age < 11, "VAS", eligibility))
# allqolie_c %>% filter(type != eligibility)

```
build new instances based on the time order. 

why there's only 800 participants?
number of participants who has at least one time record to be over 11 is 851. 

```{r}
fu %>% filter(agefu > 11) %>% distinct(record_id)

```
dateqolie0 is the first time of qolie, no matter the relationship with the datebaseline. 
dateqolie1 is better to be 2 month later than dateqolie0. but I can accept before or later. 
dateqolie2 is
dateqolie3 is the last time of qolie and it should be more than at least 300 days. on 2022. 


```{r}
allqolie_c %>% filter(dateqolie < datebaseline) %>% select(record_id, dateqolie) %>% left_join(allqolie_c, by = "record_id")
allqolie_c %>% mutate(datediff = difftime(dateqolie,datebaseline, units = "days")) %>% count(instance, datediff) %>% group_by(instance) %>% mutate(n_sum = sum(n))
datediff = allqolie_c %>% mutate(datediff = difftime(dateqolie,datebaseline, units = "days")) %>% count(instance, datediff)

allqolie_c %>% mutate(datediff = difftime(dateqolie,datebaseline, units = "days")) %>% filter(datediff > 300) %>% select(record_id, datediff, dateqolie) %>% left_join(allqolie_c, by = "record_id") %>% arrange(datediff)

ggplot(datediff, aes(x = datediff, y = datediff)) + geom_point()

#allqolie_c %>% filter(is.na(dateqolie))
# find the first:
#allqolie_c$order = NA
#allqolie_c[1, "order"] = 0



for (i in 2:nrow(allqolie_c)) {
  if (allqolie_c[i, "record_id"] != allqolie_c[i-1, "record_id"]) {
    # the first date
    allqolie_c[i, "order"] = 0
    # whether date3(last date)
    lastfirstdate = allqolie_c %>% filter(order == 0 & record_id == allqolie_c[i-1, "record_id"]) %>% select(dateqolie) %>% pull(1)
    if (!is.na(allqolie_c[i-1, "dateqolie"]) & !is.na(lastfirstdate) & difftime(allqolie_c[i-1, "dateqolie"] %>% pull(1), lastfirstdate) > 400) {
      allqolie_c[i-1, "order"] = 3
    }
  } else {
    allqolie_c[i, "order"] = allqolie_c[i-1, "order"] + 1
  }
}

wrongEndDate = allqolie_c %>% filter(order == 3 & dateqolie < '2022-01-01') %>% select(record_id, dateqolie,order) %>% left_join(allqolie_c, by = "record_id") %>% arrange(record_id, dateqolie.y)

wrongEndDate = wrongEndDate[5:8,]
wrongEndDate$reorder = c(0,1,2,3)

# for those only have one time qolie -- age so young
newQolieUsers = allqolie_c %>% filter(order == 0 & dateqolie > '2022-01-01') %>% select(record_id, dateqolie, order) %>% mutate(reorder = 3)
allqolie_c = allqolie_c %>% left_join(newQolieUsers)

allqolie_c %>% filter(order == 1 | order == 2)

wrongStartDate = allqolie_c %>% filter(order == 0) %>% select(record_id, dateqolie, order) %>% left_join(allqolie_c, by = "record_id", suffix = c("_0","_all")) %>% filter(dateqolie_0 > dateqolie_all) %>% select(record_id) %>% left_join(allqolie_c) %>% arrange(record_id, dateqolie)

wrongStartDate$reorder = c(0,1,2,3,0,1,2,3,0,1,2,3,1,3,1,3)
wrongStartDate$remove = c(rep(NA,12), 1, 0, 1, 0)

allqolie_c = allqolie_c %>% left_join(wrongEndDate %>% select(record_id, age, reorder), by = c("record_id", "age"))
allqolie_c  = allqolie_c %>% left_join(wrongStartDate %>% select(record_id, age, reorder,remove), by = c("record_id", "age"))
allqolie_c = allqolie_c %>% left_join(wrongMiddle1, by = c("record_id", "dateqolie", "order"))
allqolie_c = allqolie_c %>% left_join(wrongMiddle2, by = c("record_id", "dateqolie", "order"))

allqolie_c = allqolie_c %>% mutate(reorder = ifelse(!is.na(reorder.x), reorder.x, reorder)) %>% mutate(reorder = ifelse(!is.na(reorder.y), reorder.y, reorder)) %>% select(-reorder.x, -reorder.y)

allqolie_c %>% filter(!is.na(reorder))

allqolie_ordered = allqolie_c %>% mutate(order = ifelse(!is.na(reorder), reorder, order)) %>% select(-reorder) 
allqolie_ordered %>% arrange(desc(qolietimes), record_id, order)

allqolie_ordered %>% filter(order == 0) %>% select(record_id, dateqolie, order) %>% left_join(allqolie_ordered, by = "record_id", suffix = c("_0","_all")) %>% filter(dateqolie_0 > dateqolie_all)

wrongMiddle1 = allqolie_ordered %>% filter(order == 3) %>% select(record_id, dateqolie, order) %>% left_join(allqolie_ordered, by = "record_id", suffix = c("_3","_all")) %>% filter(dateqolie_3 < dateqolie_all) %>% select(record_id) %>% left_join(allqolie_ordered) %>% select(record_id, dateqolie, order, remove) %>% arrange(record_id, dateqolie)

wrongMiddle2 = allqolie_ordered %>% filter(order == 2) %>% select(record_id, dateqolie, order) %>% left_join(allqolie_ordered %>% filter(order == 1), by = "record_id", suffix = c("_2","_1"))  %>% filter(dateqolie_2 < dateqolie_1) %>% select(record_id) %>% left_join(allqolie_ordered) %>% select(record_id, dateqolie, order, remove) %>% arrange(record_id, dateqolie)

wrongMiddle1$reorder = c(0,1,2,3,1,3)
wrongMiddle1$remove = c(NA,NA,1,0,1,0)
wrongMiddle2$reorder = c(0,1,2,0,1,2,3,0,1,2,0,1,2)
wrongMiddle2[12,"remove"] = 1
wrongMiddle2[12,"remove"] = 0

allqolie_ordered[allqolie_ordered$record_id == "PHC-74---82-2020-09-02 09:26" & allqolie_ordered$dateqolie == "2022-07-06", "order"] = 1
allqolie_ordered[allqolie_ordered$record_id == "PHC-74---82-2020-09-02 09:26" & allqolie_ordered$dateqolie == "2022-07-06", "remove"] = 1

allqolie_ordered%>% filter(order != 3 & dateqolie > '2022-01-01') %>% select(record_id) %>% left_join(allqolie_ordered)

# take NA to be #2 if 4. 
allqolie_ordered %>% filter(is.na(dateqolie) & qolietimes == 4) %>% select(record_id) %>% left_join(allqolie_ordered)
allqolie_ordered[allqolie_ordered$record_id == "PHC---156-16-2020-09-02 09:28" & allqolie_ordered$order == 1, "order"] = 2
allqolie_ordered[allqolie_ordered$record_id == "PHC---156-16-2020-09-02 09:28" & allqolie_ordered$miss_item == 0, "order"] = 1


allq = allqolie_ordered %>% select(-qolietimes, -ev0, -instance) %>% rename(datebirth = bd) %>% arrange(record_id, order)


allq %>% filter(order == 1 & dateqolie > '2022-01-01') %>% select(record_id) %>% left_join(allq)
allq[allq$record_id == "PHC---154-63-2020-06-30 22:12", "order"] = c(2,3)
allq[allq$record_id == "PHC-23---9-2020-07-14 23:18", "order"] = c(2,3)
allq[allq$record_id == "PHC-31---45-2020-07-15 06:12", "order"] = c(2,3)
allq[allq$record_id == "PHC-74---82-2020-09-02 09:26", "order"] = c(2,3)
```

## new dataset
as no homogeny among the middle time, delete the middle times and only leave the cases with the first time and second time

should q31 and q48 on the same scale? -- base on the norm and normalized?

```{r all}
allq %>% filter(order == 2) %>% select(record_id) %>% left_join(allq)

ggplot(data=allq) + 
  geom_histogram(aes(x=miss_item),binwidth = 1) +
  facet_grid(study_arm~.) +
  theme_minimal() +
  xlab("Number of missing item") + ylab("Freq") +
  ggtitle("Missing any of the questions in QOLIE")

allq %>% group_by(study_arm, order) %>% summarise(n_records = n(), mean_score = mean(score))

allq %>% group_by(order) %>% mutate(datediff = difftime(dateqolie, datebaseline, units = "days")) %>% count(datediff)
# as no homogeny among the middle time

allq %>% filter(order != 2) %>%
  ggplot(aes(x=score)) + 
  geom_histogram(binwidth = 2) +
  facet_grid(study_arm ~ order) +
  theme_minimal() +
  xlab("QOLIE") + ylab("Freq") +
  ggtitle("Distribution of valid QOLIE scores")


qinfo = allq %>% filter(order == 1 | order == 3) %>% left_join(gender) %>% left_join(location)

qinfo = allq %>% count(record_id) %>% filter(n >= 2) %>% select(record_id) %>% left_join(allq) %>% filter(order == 1 | order == 3) %>% left_join(gender) %>% left_join(location) %>% filter(type == eligibility)

t.test(
  score ~ factor(study_arm),
  data = qinfo,
  var.equal = TRUE
)

# I'm thinking about diff-in-diff
summary(lm(score ~ factor(study_arm) + factor(order) + factor(study_arm):factor(order), qinfo))
summary(lm(score ~ factor(study_arm) + factor(order) + factor(gender), qinfo))
summary(lm(score ~ factor(study_arm) + factor(order) + factor(study_arm):factor(order) + factor(city), qinfo))

save(r31, r48, allq, gender, location, file = "all_qolie_together.rda")
```